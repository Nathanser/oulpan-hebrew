<section class="card set-builder">
  <div class="builder-header">
    <div>
      <p class="eyebrow"><%= set ? 'Modifier ma liste' : 'Créer une nouvelle liste' %></p>
      <h1><%= set ? set.name : 'Nouvelle liste' %></h1>
    </div>
    <div class="builder-actions">
      <a class="link back-link" href="/my/lists">&#8592; Retour</a>
    </div>
  </div>

  <% if (error) { %>
    <div class="alert alert-error"><%= error %></div>
  <% } %>
  <div class="form-banner" id="form-banner" style="display:none;"></div>

  <form id="list-builder-form" method="post" action="<%= action %>" class="builder-form">
    <div class="title-field title-with-action">
      <div class="title-label">Titre de la liste</div>
      <div class="title-input-row">
        <input type="text" name="name" value="<%= set ? set.name : '' %>" placeholder="Titre de la liste" required />
        <button type="button" class="dots-btn list-mode-btn" id="list-mode-toggle" aria-haspopup="true" aria-expanded="false" aria-label="Options de la liste">&#8230;</button>
        <div class="list-mode-menu" id="list-mode-menu">
          <button type="button" class="menu-item" data-mode="reorder">
            <span class="menu-label">Changer l'ordre</span>
            <span class="menu-icon">&#8693;</span>
          </button>
          <button type="button" class="menu-item danger" data-mode="delete">
            <span class="menu-label">Supprimer</span>
            <span class="menu-icon">&#128465;</span>
          </button>
        </div>
      </div>
    </div>

    <div id="cards-container" class="cards-stack">
      <% (cards || []).forEach((card, idx) => { %>
        <div class="builder-card" data-card-index="<%= idx %>" id="card-<%= card.id ? card.id : 'new-' + idx %>">
          <div class="builder-card-head">
            <div class="card-number"><%= idx + 1 %></div>
            <div class="card-head-actions">
              <button type="button" class="reorder-handle" data-drag-handle title="Réordonner cette carte">&#9776;</button>
              <label class="select-toggle">
                <input type="checkbox" data-select-checkbox aria-label="Sélectionner cette carte pour suppression" />
                <span class="select-box"></span>
              </label>
            </div>
          </div>
          <div class="builder-fields">
            <input type="hidden" data-field="id" name="cards[<%= idx %>][id]" value="<%= card.id || '' %>" />
            <label class="field-hebrew"><span class="field-label">Mot hebreu</span>
              <input data-field="hebrew" name="cards[<%= idx %>][hebrew]" type="text" value="<%= card.hebrew || '' %>" placeholder="שָׁלוֹם" required />
            </label>
            <label class="field-french"><span class="field-label">Mot francais</span>
              <input data-field="french" name="cards[<%= idx %>][french]" type="text" value="<%= card.french || '' %>" placeholder="Bonjour" required />
            </label>
            <label class="field-translit"><span class="field-label">Phonetique</span>
              <input data-field="transliteration" name="cards[<%= idx %>][transliteration]" type="text" value="<%= card.transliteration || '' %>" placeholder="Shalom" />
            </label>
          </div>
        </div>
      <% }) %>
    </div>

    <div class="bulk-action-bar" id="bulk-action-bar">
      <button type="button" class="bulk-trash" id="bulk-delete-btn" disabled aria-label="Supprimer les cartes sélectionnées">&#128465;</button>
      <div class="bulk-count" id="bulk-count">0 sélectionné</div>
    </div>

    <div class="list-bottom-actions fixed-actions">
      <button type="button" class="cta secondary" id="add-card-bottom">Ajouter des cartes</button>
      <button type="submit" form="list-builder-form" class="cta">Enregistrer la liste</button>
    </div>
  </form>

  <template id="card-template">
    <div class="builder-card" data-card-index="__index__" id="card-new-__index__">
      <div class="builder-card-head">
        <div class="card-number"></div>
        <div class="card-head-actions">
          <button type="button" class="reorder-handle" data-drag-handle title="Réordonner cette carte">&#9776;</button>
          <label class="select-toggle">
            <input type="checkbox" data-select-checkbox aria-label="Sélectionner cette carte pour suppression" />
            <span class="select-box"></span>
          </label>
        </div>
      </div>
      <div class="builder-fields">
        <input type="hidden" data-field="id" name="" value="" />
        <label class="field-hebrew"><span class="field-label">Mot hebreu</span>
          <input data-field="hebrew" name="" type="text" value="" placeholder="שָׁלוֹם" required />
        </label>
        <label class="field-french"><span class="field-label">Mot francais</span>
          <input data-field="french" name="" type="text" value="" placeholder="Bonjour" required />
        </label>
        <label class="field-translit"><span class="field-label">Phonetique</span>
          <input data-field="transliteration" name="" type="text" value="" placeholder="Shalom" />
        </label>
      </div>
    </div>
  </template>
</section>

<script src="/builder.js"></script>
<script>
  window.initCardBuilder && window.initCardBuilder({
    containerId: 'cards-container',
    templateId: 'card-template',
    addButtonId: 'add-card-bottom',
    formId: 'list-builder-form',
    bannerId: 'form-banner',
    modeToggleId: 'list-mode-toggle',
    modeMenuId: 'list-mode-menu',
    bulkBarId: 'bulk-action-bar',
    bulkDeleteBtnId: 'bulk-delete-btn',
    bulkCountId: 'bulk-count'
  });
</script>
