<section>
  <div class="list-header">
    <h1>Utilisateurs</h1>
    <a class="btn" href="/admin/users/new">Ajouter un utilisateur</a>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>Prénom</th>
        <th>Nom</th>
        <th>Nom affiché</th>
        <th>Email</th>
        <th>Niveau</th>
        <th>Rôle</th>
        <th>Créé le</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% users.forEach((u, idx)=> { %>
        <tr>
          <td>
            <%= idx + 1 %>
          </td>
          <td>
            <%= u.first_name || '' %>
          </td>
          <td>
            <%= u.last_name || '' %>
          </td>
          <td>
            <%= u.display_name %>
          </td>
          <td>
            <%= u.email %>
          </td>
          <td>
            <%= u.level || '-' %>
          </td>
          <td>
            <%= u.role %>
          </td>
          <td>
            <%= u.created_at %>
          </td>
          <td>
            <div class="table-menu">
              <button class="btn ghost icon-btn dots-btn" type="button" aria-label="Actions">&#8942;</button>
              <div class="card-menu">
                <a class="menu-item" href="/admin/users/<%= u.id %>/edit">&#9998; Modifier</a>
                <form action="/admin/users/<%= u.id %>/reset" method="post">
                  <button type="submit" class="menu-item">&#128472; Reset stats</button>
                </form>
                <form action="/admin/users/<%= u.id %>?_method=DELETE" method="post"
                  data-confirm="Supprimer cet utilisateur ?">
                  <button type="submit" class="menu-item danger">&#128465; Supprimer</button>
                </form>
              </div>
            </div>
          </td>
        </tr>
        <% }) %>
    </tbody>
  </table>
</section>

<script>
  (() => {
    const menus = Array.from(document.querySelectorAll('.table-menu'));
    menus.forEach(menu => {
      const btn = menu.querySelector('.dots-btn');
      const panel = menu.querySelector('.card-menu');
      if (!btn || !panel) return;
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        document.querySelectorAll('.table-menu .card-menu').forEach(p => {
          if (p !== panel) p.classList.remove('open');
        });
        panel.classList.toggle('open');
      });
    });
    document.addEventListener('click', () => {
      document.querySelectorAll('.table-menu .card-menu').forEach(p => p.classList.remove('open'));
    });
  })();
</script>
