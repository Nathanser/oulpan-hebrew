<% const activeCount = (words || []).filter(w => Number(w.active)).length; %>
<% const inactiveCount = (words || []).length - activeCount; %>

<section class="card list-screen">
  <div class="list-screen-head">
    <div>
      <a class="link back-link" id="back-link" href="/admin/themes">&#8592; Retour</a>
      <br><br>
      <h1><%= theme.name %></h1>
      <p class="muted mini">Theme par defaut - <%= theme.active ? 'Actif' : 'Inactif' %></p>
    </div>
    <div class="list-screen-actions inline-actions">
      <form action="/admin/themes/<%= theme.id %>/toggle" method="post" style="display:inline;">
        <button type="submit" class="btn ghost"><%= theme.active ? 'Desactiver' : 'Activer' %></button>
      </form>
      <a class="btn ghost" href="/admin/themes/<%= theme.id %>/edit">Modifier le theme</a>
    </div>
  </div>

  <br>

  <div class="tab-row" id="card-tabs">
    <button class="tab-chip active" data-tab="all">Tous les mots (<%= words.length %>)</button>
    <button class="tab-chip" data-tab="active">Actifs (<%= activeCount %>)</button>
    <button class="tab-chip" data-tab="inactive">Inactifs (<%= inactiveCount %>)</button>
  </div>

  <div class="search-bar-row">
    <div class="search-row">
      <span class="search-icon">&#128269;</span>
      <input type="search" id="card-search" placeholder="Recherche (hebreu, francais, phonetique)" />
    </div>
    <div class="search-actions">
      <button type="button" class="icon-btn ghost" id="select-toggle" title="Deplacer des mots">&#x21C4;</button>
      <button type="button" class="icon-btn danger" id="select-cancel" style="display:none;" title="Annuler">&#10060;</button>
    </div>
  </div>

  <div class="alert alert-error" id="select-banner" style="display:none;"></div>

  <div class="cards-wall" id="cards-wall">
    <% if (!words || words.length === 0) { %>
      <div class="wall-empty">
        <p>Aucun mot.</p>
      </div>
    <% } else { %>
      <% words.forEach((word, idx) => { %>
        <div class="word-card <%= word.active ? '' : 'is-inactive' %>" data-active="<%= word.active ? 1 : 0 %>" data-search="<%= (word.hebrew + ' ' + word.french + ' ' + (word.transliteration || '')).toLowerCase() %>">
          <div class="word-card-top">
            <div class="word-card-actions">
              <a class="icon-btn ghost" href="/admin/words?search=<%= encodeURIComponent(word.french) %>" title="Ouvrir dans la page mots">&#9998;</a>
            </div>
            <label class="card-select">
              <input type="checkbox" class="card-check" value="<%= word.id %>" />
            </label>
          </div>
          <div class="word-card-body">
            <div class="word-index"><%= idx + 1 %></div>
            <p class="hebrew-word"><%= word.hebrew %></p>
            <p class="french-word"><%= word.french %></p>
            <% if (word.transliteration) { %>
              <p class="translit"><em><%= word.transliteration %></em></p>
            <% } %>
          </div>
          <div class="word-card-inline-actions">
            <form method="post" action="/admin/themes/<%= theme.id %>/words/<%= word.id %>/action">
              <input type="hidden" name="action" value="toggle_active" />
              <button type="submit" class="icon-btn ghost" title="<%= word.active ? 'Masquer' : 'Rendre actif' %>">&#128065;</button>
            </form>
            <form method="post" action="/admin/themes/<%= theme.id %>/words/<%= word.id %>/action" onsubmit="return confirm('Supprimer ce mot ?');">
              <input type="hidden" name="action" value="delete" />
              <button type="submit" class="icon-btn ghost danger" title="Supprimer">&#128465;</button>
            </form>
          </div>
          <div class="word-card-flags">
            <% if (!word.active) { %><span class="pill muted">Inactif</span><% } %>
          </div>
        </div>
      <% }) %>
    <% } %>
  </div>

  <div class="list-bottom-actions fixed-actions">
    <button type="button" class="cta" id="main-action" data-edit-url="/admin/themes/<%= theme.id %>/edit">Ajouter des mots</button>
    <a class="cta secondary" id="return-link" href="/admin/themes">Retour aux themes</a>
  </div>
</section>

<div class="modal-backdrop" id="move-modal" style="display:none;">
  <div class="modal-card">
    <h3>Deplacer vers</h3>
    <% if (!targetThemes || targetThemes.length === 0) { %>
      <p class="muted">Pas d'autre theme disponible.</p>
    <% } else { %>
      <div class="options-list">
        <% targetThemes.forEach(t => { %>
          <label class="option-row">
            <input type="radio" name="target_theme" value="<%= t.id %>" />
            <span><%= t.name %></span>
          </label>
        <% }) %>
      </div>
    <% } %>
    <div class="alert alert-error" id="move-error" style="display:none;"></div>
    <div class="inline-actions modal-actions">
      <button type="button" class="btn" id="confirm-move">Valider</button>
      <button type="button" class="btn ghost" id="cancel-move">Annuler</button>
    </div>
  </div>
</div>
<form id="move-form" method="post" action="/admin/themes/<%= theme.id %>/move"></form>

<script>
  (() => {
    const tabs = Array.from(document.querySelectorAll('[data-tab]'));
    const cards = Array.from(document.querySelectorAll('.word-card'));
    const search = document.getElementById('card-search');
    let currentTab = 'all';
    const applyFilters = () => {
      const term = search ? search.value.trim().toLowerCase() : '';
      cards.forEach(card => {
        const isActive = card.dataset.active === '1';
        const matchesTab = currentTab === 'all' ? true : currentTab === 'active' ? isActive : !isActive;
        const matchesSearch = !term || (card.dataset.search || '').includes(term);
        card.style.display = matchesTab && matchesSearch ? '' : 'none';
      });
    };

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        applyFilters();
      });
    });

    if (search) {
      search.addEventListener('input', applyFilters);
    }

    const selectBtn = document.getElementById('select-toggle');
    const cancelSelectBtn = document.getElementById('select-cancel');
    const mainAction = document.getElementById('main-action');
    const backLink = document.getElementById('back-link');
    const returnLink = document.getElementById('return-link');
    const banner = document.getElementById('select-banner');
    const modal = document.getElementById('move-modal');
    const confirmMove = document.getElementById('confirm-move');
    const cancelMove = document.getElementById('cancel-move');
    const moveForm = document.getElementById('move-form');
    const moveError = document.getElementById('move-error');
    const cardChecks = Array.from(document.querySelectorAll('.card-check'));
    let selecting = false;

    const getSelectedIds = () => cardChecks.filter(cb => cb.checked).map(cb => cb.value);
    const showBanner = (msg) => {
      if (!banner) return;
      banner.textContent = msg;
      banner.style.display = 'block';
      setTimeout(() => { banner.style.display = 'none'; }, 2200);
    };

    const closeModal = () => {
      if (modal) modal.style.display = 'none';
      if (moveError) moveError.style.display = 'none';
    };

    const updateSelectionUI = () => {
      document.querySelectorAll('.word-card-actions, .word-card-inline-actions').forEach(el => {
        el.style.display = selecting ? 'none' : '';
      });
      document.querySelectorAll('.card-select').forEach(el => {
        el.style.display = selecting ? 'flex' : 'none';
      });
      if (backLink) backLink.style.display = selecting ? 'none' : '';
      if (returnLink) returnLink.style.display = selecting ? 'none' : '';
      if (selectBtn) selectBtn.style.display = selecting ? 'none' : '';
      if (cancelSelectBtn) cancelSelectBtn.style.display = selecting ? '' : 'none';
      if (mainAction) {
        mainAction.textContent = selecting ? 'Deplacer ces mots' : 'Ajouter des mots';
        const disabled = selecting && getSelectedIds().length === 0;
        mainAction.classList.toggle('is-disabled', disabled);
        mainAction.dataset.disabled = disabled ? '1' : '0';
      }
    };

    const exitSelection = () => {
      selecting = false;
      cardChecks.forEach(cb => { cb.checked = false; });
      closeModal();
      updateSelectionUI();
    };

    if (selectBtn) {
      selectBtn.addEventListener('click', () => {
        selecting = true;
        updateSelectionUI();
      });
    }
    if (cancelSelectBtn) {
      cancelSelectBtn.addEventListener('click', exitSelection);
    }

    cardChecks.forEach(cb => {
      cb.addEventListener('change', () => {
        if (mainAction && selecting) {
          const disabled = getSelectedIds().length === 0;
          mainAction.classList.toggle('is-disabled', disabled);
          mainAction.dataset.disabled = disabled ? '1' : '0';
        }
      });
    });

    const openModal = () => {
      if (!selecting) return;
      if (getSelectedIds().length === 0) {
        showBanner('Selectionne au moins un mot.');
        return;
      }
      if (modal) modal.style.display = 'flex';
    };

    if (mainAction) {
      mainAction.addEventListener('click', (e) => {
        if (!selecting) {
          const url = mainAction.getAttribute('data-edit-url');
          if (url) window.location.href = url;
          return;
        }
        e.preventDefault();
        if (mainAction.dataset.disabled === '1') {
          showBanner('Selectionne au moins un mot.');
          return;
        }
        openModal();
      });
    }

    if (cancelMove) {
      cancelMove.addEventListener('click', (e) => {
        e.preventDefault();
        closeModal();
      });
    }

    if (confirmMove && moveForm) {
      confirmMove.addEventListener('click', (e) => {
        e.preventDefault();
        const selected = getSelectedIds();
        if (selected.length === 0) {
          showBanner('Selectionne au moins un mot.');
          closeModal();
          return;
        }
        const target = document.querySelector('input[name="target_theme"]:checked');
        if (!target) {
          if (moveError) {
            moveError.textContent = 'Choisis une destination.';
            moveError.style.display = 'block';
          }
          return;
        }
        moveForm.innerHTML = '';
        selected.forEach(id => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'word_ids';
          input.value = id;
          moveForm.appendChild(input);
        });
        const targetInput = document.createElement('input');
        targetInput.type = 'hidden';
        targetInput.name = 'target_theme_id';
        targetInput.value = target.value;
        moveForm.appendChild(targetInput);
        moveForm.submit();
      });
    }

    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }

    applyFilters();
    updateSelectionUI();
  })();
</script>
