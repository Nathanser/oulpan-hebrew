<section class="card">
  <h1>Mes informations</h1>

  <% if (message) { %>
    <div class="alert alert-success">
      <%= message %>
    </div>
    <% } %>
      <% if (pwdMessage) { %>
        <div class="alert alert-success">
          <%= pwdMessage %>
        </div>
        <% } %>
          <% if (error) { %>
            <div class="alert alert-error">
              <%= error %>
            </div>
            <% } %>

              <form method="post" action="/profile/info" class="form">
                <label>Prénom
                  <input type="text" name="first_name" value="<%= user ? user.first_name : '' %>" placeholder="David"
                    required />
                </label>

                <label>Nom
                  <input type="text" name="last_name" value="<%= user ? user.last_name : '' %>" placeholder="COHEN" />
                </label>

                <label>Nom affiché
                  <input type="text" name="display_name" value="<%= user ? user.display_name : '' %>"
                    placeholder="David COHEN" required />
                </label>

                <label>Email
                  <input type="email" name="email" value="<%= user ? user.email : '' %>"
                    placeholder="david@hebrewlearn.fr" required />
                </label>

                <label>Niveau
                  <select name="level" required>
                    <% (levels || []).forEach(lvl=> { %>
                      <option value="<%= lvl %>" <%=user && user.level===lvl ? 'selected' : '' %>><%= lvl %>
                      </option>
                      <% }) %>
                  </select>
                </label>

                <button type="submit" class="btn ghost">Mettre à jour</button>
              </form>
</section>

<section class="card">
  <h2>Color Theme</h2>
  <form method="post" action="/profile/theme" class="form">
    <div class="mode-grid">
      <label class="check-row">
        <input type="radio" name="theme" value="dark" <%=(!user.theme || user.theme==='dark' ) ? 'checked' : '' %>>
        <span style="white-space: nowrap;">Thème sombre</span>
      </label>
      <label class="check-row">
        <input type="radio" name="theme" value="light" <%=(user.theme==='light' ) ? 'checked' : '' %>>
        <span style="white-space: nowrap;">Thème clair</span>
      </label>
    </div>
    <button type="submit" class="btn ghost" style="margin-top:0.5rem;">Enregistrer le thème</button>
  </form>
</section>

<section class="card">
  <h2>Mode de révision par défaut</h2>
  <% if (prefMessage) { %>
    <div class="alert alert-success">
      <%= prefMessage %>
    </div>
    <% } %>
      <% if (prefError) { %>
        <div class="alert alert-error">
          <%= prefError %>
        </div>
        <% } %>

          <% const defParams=defaultParams || {}; const defModes=Array.isArray(defParams.modes) ? defParams.modes :
            [defParams.modes || 'flashcards' ]; const defThemes=new Set((defParams.theme_ids || []).map(v=> String(v)));
            const defSets = new Set((defParams.set_ids || []).map(v => String(v)));
            const defRemaining = defParams.remaining === 'all' ? 'all' : String(defParams.remaining || 10);
            const defRevMode = defParams.rev_mode || 'order';
            const defPhonetic = typeof defParams.show_phonetic !== 'undefined' ? String(defParams.show_phonetic) : '1';
            const defLevel = defParams.level_id ? String(defParams.level_id) : '';
            %>
            <p class="muted mini">Ces réglages seront pré-remplis dans la configuration de révision. Tu pourras toujours
              les modifier avant de lancer une session.</p>

            <form method="post" action="/profile/revision-defaults" class="form" id="defaults-form"
              data-levels="<%= JSON.stringify(trainLevels || []) %>"
              data-default-params="<%= JSON.stringify(defaultParams || {}) %>">
              <div class="field-block">
                <div class="field-title">Modes de révision</div>
                <div class="mode-grid">
                  <label class="check-row">
                    <input type="checkbox" name="modes[]" value="flashcards" <%=defModes.includes('flashcards')
                      ? 'checked' : '' %>>
                    <span>Flashcards classique</span>
                  </label>
                  <label class="check-row">
                    <input type="checkbox" name="modes[]" value="flashcards_reverse"
                      <%=defModes.includes('flashcards_reverse') ? 'checked' : '' %>>
                    <span>Flashcards reverse</span>
                  </label>
                  <label class="check-row">
                    <input type="checkbox" name="modes[]" value="written" <%=defModes.includes('written') ? 'checked'
                      : '' %>>
                    <span>Révision par écrit</span>
                  </label>
                </div>
              </div>

              <div class="field-block">
                <div class="field-title">Thèmes et listes</div>
                <div class="theme-toggles inline">
                  <label class="check-row"><input type="checkbox" id="pref-toggle-public" <%=defThemes.size> 0 ?
                    'checked' : '' %>> <span>Thèmes en ligne</span></label>
                  <label class="check-row"><input type="checkbox" id="pref-toggle-lists" <%=(trainSets || []).some(s=>
                    defSets.has(String(s.id))) ? 'checked' : '' %>> <span>Mes listes</span></label>
                  <label class="check-row"><input type="checkbox" id="pref-toggle-shared" <%=(trainSharedSets ||
                      []).some(s=> defSets.has(String(s.id))) ? 'checked' : '' %>> <span>Listes partagées</span></label>
                </div>

                <div class="theme-groups">
                  <div class="theme-group" id="pref-public-group" style="display:none;">
                    <p class="muted mini" style="margin:0 0 0.2rem;">Thèmes en ligne</p>
                    <% if (!trainThemes || trainThemes.length===0) { %>
                      <p class="muted mini">Aucun thème en ligne disponible.</p>
                      <% } else { %>
                        <ul class="custom-select-container">
                          <% trainThemes.forEach(t=> { %>
                            <% if (t.children && t.children.length> 0) { %>
                              <li>
                                <div class="theme-row parent-row">
                                  <button type="button" class="icon-btn ghost toggle-subthemes-btn"
                                    data-target="pref-subthemes-<%= t.id %>" aria-expanded="false">
                                    <span class="chevron-icon">&#9654;</span>
                                  </button>
                                  <span class="theme-label">
                                    <%= t.name %>
                                  </span>
                                </div>
                                <ul id="pref-subthemes-<%= t.id %>" style="display:none;">
                                  <% t.children.forEach(child=> { %>
                                    <li>
                                      <div class="theme-row">
                                        <input type="checkbox" name="theme_ids[]" value="<%= child.id %>"
                                          id="pref-theme-<%= child.id %>" <%=defThemes.has(String(child.id)) ? 'checked'
                                          : '' %>>
                                        <label for="pref-theme-<%= child.id %>">
                                          <%= child.name %>
                                        </label>
                                      </div>
                                    </li>
                                    <% }) %>
                                </ul>
                              </li>
                              <% } else { %>
                                <li>
                                  <div class="theme-row">
                                    <input type="checkbox" name="theme_ids[]" value="<%= t.id %>"
                                      id="pref-theme-<%= t.id %>" <%=defThemes.has(String(t.id)) ? 'checked' : '' %>>
                                    <label for="pref-theme-<%= t.id %>">
                                      <%= t.name %>
                                    </label>
                                  </div>
                                </li>
                                <% } %>
                                  <% }) %>
                        </ul>
                        <% } %>
                  </div>

                  <div class="theme-group" id="pref-list-group" style="display:none;">
                    <p class="muted mini" style="margin:0 0 0.2rem;">Mes Listes</p>
                    <% if (!trainSets || trainSets.length===0) { %>
                      <p class="muted mini">Aucune liste pour le moment.</p>
                      <% } else { %>
                        <ul class="custom-select-container">
                          <% trainSets.forEach(s=> { %>
                            <li>
                              <div class="theme-row">
                                <input type="checkbox" name="set_ids[]" value="<%= s.id %>" id="pref-set-<%= s.id %>"
                                  <%=defSets.has(String(s.id)) ? 'checked' : '' %>>
                                <label for="pref-set-<%= s.id %>">
                                  <%= s.name %>
                                </label>
                              </div>
                            </li>
                            <% }) %>
                        </ul>
                        <% } %>
                  </div>

                  <div class="theme-group" id="pref-shared-list-group" style="display:none;">
                    <p class="muted mini" style="margin:0 0 0.2rem;">Listes partagées</p>
                    <% if (!trainSharedSets || trainSharedSets.length===0) { %>
                      <p class="muted mini">Aucune liste partagée.</p>
                      <% } else { %>
                        <ul class="custom-select-container">
                          <% trainSharedSets.forEach(s=> { %>
                            <li>
                              <div class="theme-row">
                                <input type="checkbox" name="set_ids[]" value="<%= s.id %>"
                                  id="pref-shared-set-<%= s.id %>" <%=defSets.has(String(s.id)) ? 'checked' : '' %>>
                                <label for="pref-shared-set-<%= s.id %>">
                                  <%= s.name %> (<%= s.owner_name %>)
                                </label>
                              </div>
                            </li>
                            <% }) %>
                        </ul>
                        <% } %>
                  </div>
                </div>
              </div>

              <div class="field-block" id="pref-level-field" style="display:none;">
                <label>Niveau
                  <select name="level_id" id="pref-level-select">
                    <option value="">(Tous les niveaux)</option>
                  </select>
                </label>
              </div>

              <div class="field-block">
                <div class="field-title">Nombre de mots</div>
                <div class="mode-grid">
                  <label class="check-row">
                    <input type="radio" name="remaining_mode" value="all" id="pref-rm-all" <%=defRemaining==='all'
                      ? 'checked' : '' %>>
                    <span style="white-space: nowrap;">Tout le thème/liste</span>
                  </label>
                  <label class="check-row">
                    <input type="radio" name="remaining_mode" value="custom" id="pref-rm-custom" <%=defRemaining
                      !=='all' ? 'checked' : '' %>>
                    <span style="white-space: nowrap;">Nombre défini</span>
                  </label>
                </div>
                <div id="pref-slider-container" style="display:none; margin-top:0.5rem; padding-left:0.5rem;">
                  <div style="display:flex; align-items:center; gap:0.75rem;">
                    <input type="range" min="1" max="50" value="<%= defRemaining !== 'all' ? defRemaining : '10' %>"
                      id="pref-remaining-slider" style="flex:1; cursor:pointer;">
                    <span id="pref-slider-val" style="font-weight:700; min-width:1.5rem; text-align:right;">
                      <%= defRemaining !=='all' ? defRemaining : '10' %>
                    </span>
                  </div>
                </div>
                <input type="hidden" name="remaining" id="pref-remaining-input" value="<%= defRemaining %>">
                <input type="hidden" name="total" value="<%= defRemaining %>">
              </div>

              <div class="field-block">
                <label>Mode de révision
                  <select name="rev_mode">
                    <option value="order" <%=defRevMode==='order' ? 'selected' : '' %>>Dans l'ordre</option>
                    <option value="random" <%=defRevMode==='random' ? 'selected' : '' %>>Aléatoire</option>
                    <option value="favorites" <%=defRevMode==='favorites' ? 'selected' : '' %>>Favoris</option>
                    <option value="new" <%=defRevMode==='new' ? 'selected' : '' %>>Nouveaux mots</option>
                    <option value="weak" <%=defRevMode==='weak' ? 'selected' : '' %>>Mots faibles / Non maîtrisés
                    </option>
                  </select>
                </label>
                <fieldset class="check-row" style="margin-top:0.5rem;">
                  <legend style="margin-bottom:0.35rem;">Phonétique ?</legend>
                  <label class="check-row">
                    <input type="radio" name="show_phonetic" value="1" <%=defPhonetic !=='0' ? 'checked' : '' %>>
                    <span>Oui</span>
                  </label>
                  <label class="check-row">
                    <input type="radio" name="show_phonetic" value="0" <%=defPhonetic==='0' ? 'checked' : '' %>>
                    <span>Non</span>
                  </label>
                </fieldset>
              </div>

              <div class="mode-switch" style="justify-content:flex-start; gap:0.5rem;">
                <button type="submit" class="btn">Enregistrer</button>
                <button type="submit" form="defaults-reset" class="btn ghost">Reset par défaut</button>
              </div>
            </form>
            <form id="defaults-reset" method="post" action="/profile/revision-defaults/reset"></form>
</section>

<section class="card">
  <h2>Sécurité</h2>
  <form method="post" action="/profile/password" class="form">
    <label>Mot de passe actuel
      <input type="password" name="current_password" required />
    </label>
    <label>Nouveau mot de passe
      <input type="password" name="new_password" required />
    </label>
    <button type="submit">Changer mon mot de passe</button>
  </form>
</section>

<section class="card">
  <h2>Actions</h2>
  <div class="actions-grid" style="display:grid; gap:0.75rem;">
    <form method="post" action="/profile/reset-stats" data-confirm="Réinitialiser toutes mes stats ?">
      <button type="submit" class="btn secondary danger">Réinitialiser les stats du profil</button>
    </form>
    <br>

    <form method="post" action="/profile/delete"
      onsubmit="return confirm('Voulez-vous vraiment supprimer votre compte ? Cette action est irréversible.');">
      <label>Mot de passe (confirmation)
        <input type="password" name="password" required />
      </label>
      <br><br>
      <button type="submit" class="btn danger">Suppression du compte</button>
    </form>
  </div>
</section>

<script>
  (() => {
    const defaultsForm = document.getElementById('defaults-form');
    if (!defaultsForm) return;

    const levelsData = JSON.parse(defaultsForm.dataset.levels || '[]');
    const defaultParamsData = JSON.parse(defaultsForm.dataset.defaultParams || '{}');
    const preselectedLevel = defaultParamsData.level_id ? String(defaultParamsData.level_id) : '';
    const selectedRemainingValue = defaultParamsData.remaining === 'all'
      ? 'all'
      : String(defaultParamsData.remaining || '10');

    const levelSelect = document.getElementById('pref-level-select');
    const levelField = document.getElementById('pref-level-field');
    const publicGroup = document.getElementById('pref-public-group');
    const listGroup = document.getElementById('pref-list-group');
    const sharedListGroup = document.getElementById('pref-shared-list-group');
    const togglePublic = document.getElementById('pref-toggle-public');
    const toggleLists = document.getElementById('pref-toggle-lists');
    const toggleShared = document.getElementById('pref-toggle-shared');

    const rmAll = document.getElementById('pref-rm-all');
    const rmCustom = document.getElementById('pref-rm-custom');
    const sliderContainer = document.getElementById('pref-slider-container');
    const slider = document.getElementById('pref-remaining-slider');
    const sliderVal = document.getElementById('pref-slider-val');
    const remainingInput = document.getElementById('pref-remaining-input');

    const renderLevels = () => {
      const checkedInputs = defaultsForm.querySelectorAll('input[name="theme_ids[]"]:checked');
      const checkedThemes = Array.from(checkedInputs).map(cb => cb.value);

      levelSelect.innerHTML = '<option value="">(Tous les niveaux)</option>';

      if (checkedThemes.length !== 1) {
        levelField.style.display = 'none';
        return;
      }

      const filtered = levelsData.filter(l => String(l.theme_id) === String(checkedThemes[0]));
      if (filtered.length === 0) {
        levelField.style.display = 'none';
        return;
      }
      filtered.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id;
        opt.textContent = l.name;
        levelSelect.appendChild(opt);
      });
      levelField.style.display = 'block';
    };

    const updateGroups = () => {
      if (publicGroup) publicGroup.style.display = togglePublic && togglePublic.checked ? 'block' : 'none';
      if (listGroup) listGroup.style.display = toggleLists && toggleLists.checked ? 'block' : 'none';
      if (sharedListGroup) sharedListGroup.style.display = toggleShared && toggleShared.checked ? 'block' : 'none';
      renderLevels();
    };

    const updateSliderFill = () => {
      if (!slider) return;
      const percentage = ((slider.value - 1) / 49) * 100;
      slider.style.setProperty('--slider-fill', `${percentage}%`);
    };

    const updateRemainingUI = () => {
      if (rmAll && rmAll.checked) {
        if (sliderContainer) sliderContainer.style.display = 'none';
        if (remainingInput) remainingInput.value = 'all';
      } else {
        if (sliderContainer) sliderContainer.style.display = 'block';
        if (remainingInput && slider) remainingInput.value = slider.value;
        updateSliderFill();
      }
    };

    defaultsForm.querySelectorAll('input[name="theme_ids[]"]').forEach(cb => {
      cb.addEventListener('change', renderLevels);
    });

    if (togglePublic) togglePublic.addEventListener('change', updateGroups);
    if (toggleLists) toggleLists.addEventListener('change', updateGroups);
    if (toggleShared) toggleShared.addEventListener('change', updateGroups);

    if (rmAll) rmAll.addEventListener('change', updateRemainingUI);
    if (rmCustom) rmCustom.addEventListener('change', updateRemainingUI);
    if (slider) {
      slider.addEventListener('input', () => {
        if (sliderVal) sliderVal.textContent = slider.value;
        if (remainingInput) remainingInput.value = slider.value;
        updateSliderFill();
      });
      if (selectedRemainingValue !== 'all') slider.value = selectedRemainingValue;
    }

    updateGroups();
    if (preselectedLevel && levelSelect) {
      levelSelect.value = preselectedLevel;
      if (levelSelect.value) levelField.style.display = 'block';
    }
    updateRemainingUI();

    defaultsForm.addEventListener('submit', () => {
      const modeInputs = Array.from(defaultsForm.querySelectorAll('input[name="modes[]"]'));
      if (!modeInputs.some(i => i.checked) && modeInputs[0]) modeInputs[0].checked = true;
    });

    // Toggle subthemes visibility
    document.querySelectorAll('.toggle-subthemes-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = btn.dataset.target;
        const target = document.getElementById(targetId);
        const icon = btn.querySelector('.chevron-icon');
        if (target) {
          const isHidden = target.style.display === 'none';
          target.style.display = isHidden ? 'block' : 'none';
          btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
          icon.innerHTML = isHidden ? '&#9660;' : '&#9654;';
        }
      });
    });

    // Allow clicking parent label to toggle open/close
    document.querySelectorAll('.theme-row.parent-row .theme-label').forEach(label => {
      const parentRow = label.closest('.parent-row');
      const btn = parentRow ? parentRow.querySelector('.toggle-subthemes-btn') : null;
      if (!btn) return;
      label.addEventListener('click', () => btn.click());
    });

    // Ensure already-selected subthemes are visible on load
    document.querySelectorAll('.toggle-subthemes-btn').forEach(btn => {
      const target = document.getElementById(btn.dataset.target);
      const icon = btn.querySelector('.chevron-icon');
      if (!target) return;
      const hasCheckedChild = target.querySelector('input[type="checkbox"]:checked');
      if (hasCheckedChild) {
        target.style.display = 'block';
        btn.setAttribute('aria-expanded', 'true');
        if (icon) icon.innerHTML = '&#9660;';
      }
    });
  })();
</script>

<style>
  .custom-select-container {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    padding: 0.75rem 0.85rem;
    max-height: 320px;
    overflow-y: auto;
    list-style: none;
    margin: 0;
    border: 1px solid var(--border-main);
    border-radius: 0.85rem;
    background: var(--bg-card);
  }

  .custom-select-container>li {
    list-style: none;
    margin: 0;
  }

  .theme-row {
    display: grid;
    grid-template-columns: auto 1fr;
    align-items: center;
    column-gap: 0.45rem;
    min-height: 28px;
  }

  .theme-row input[type="checkbox"] {
    margin: 0;
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    accent-color: var(--text-faint);
  }

  .theme-row label,
  .theme-row .theme-label {
    cursor: pointer;
    user-select: none;
    margin: 0;
    padding: 0;
    flex-grow: 1;
    font-weight: 600;
    color: var(--text-main);
  }

  .theme-row.parent-row {
    grid-template-columns: 18px 1fr;
    column-gap: 0.4rem;
  }

  .theme-row.parent-row .theme-label {
    font-weight: 700;
  }

  .icon-btn.ghost {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    padding: 0;
    cursor: pointer;
    color: var(--text-muted);
    border-radius: 0.25rem;
  }

  .icon-btn.ghost:hover {
    color: var(--text-main);
    background: rgba(255, 255, 255, 0.06);
  }

  .chevron-icon {
    font-size: 0.77em;
    transition: transform 0.2s ease;
    display: inline-block;
  }

  .custom-select-container ul {
    list-style: none;
    margin: 0.25rem 0 0.2rem 0.65rem;
    padding-left: 1.25rem;
    border-left: 2px solid var(--border-main);
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .custom-select-container ul li {
    margin: 0;
  }

  .custom-select-container ul .theme-row {
    grid-template-columns: auto 1fr;
    column-gap: 0.4rem;
  }

  .custom-select-container ul .theme-row label {
    font-weight: 600;
  }
</style>




<span>Révision par écrit</span>