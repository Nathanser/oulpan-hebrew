<% const activeCount = (words || []).filter(w => Number(w.effective_active)).length; %>
<% const inactiveCount = (words || []).length - activeCount; %>

<section class="card list-screen">
  <div class="list-screen-head">
    <div>
      <a class="link back-link" href="/themes">&#8592; Retour</a>
      <h1><%= theme.name %></h1>
      <p class="muted mini"><%= theme.active ? 'Actif' : 'Inactif' %> - <%= isGlobal ? 'Theme propose' : 'Theme personnel' %></p>
    </div>
    <div class="list-screen-actions inline-actions">
      <% if (isOwner || (!theme.user_id && currentUser && currentUser.role === 'admin')) { %>
        <form action="/themes/<%= theme.id %>/toggle" method="post" style="display:inline;">
          <button class="btn ghost" type="submit" title="<%= theme.active ? 'Desactiver' : 'Activer' %>"><%= theme.active ? 'Desactiver' : 'Activer' %></button>
        </form>
        <% if (isOwner) { %>
          <a class="btn ghost" href="/my/themes/<%= theme.id %>/edit">Modifier</a>
        <% } %>
      <% } %>
    </div>
  </div>

  <div class="tab-row" id="word-tabs">
    <button class="tab-chip active" data-tab="all">Tous les mots (<%= words.length %>)</button>
    <button class="tab-chip" data-tab="active">Actifs (<%= activeCount %>)</button>
    <button class="tab-chip" data-tab="inactive">Inactifs (<%= inactiveCount %>)</button>
  </div>

  <div class="search-row">
    <span class="search-icon">&#128269;</span>
    <input type="search" id="word-search" placeholder="Recherche (hebreu, francais, phonetique)" />
  </div>

  <div class="cards-wall" id="words-wall">
    <% if (!words || words.length === 0) { %>
      <div class="wall-empty">
        <p>Pas encore de mots dans ce theme.</p>
      </div>
    <% } else { %>
      <% words.forEach((word, idx) => { 
        const isEffectiveActive = Number(word.effective_active);
        const isGlobalInactive = !Number(word.global_active);
        const isSelfOverride = !isGlobalInactive && Number(word.override_active) === 0;
      %>
        <div class="word-card <%= isEffectiveActive ? '' : 'is-inactive' %>" data-active="<%= isEffectiveActive ? 1 : 0 %>" data-search="<%= (word.hebrew + ' ' + word.french + ' ' + (word.transliteration || '')).toLowerCase() %>">
          <div class="word-card-body">
            <div class="word-index"><%= idx + 1 %></div>
            <p class="hebrew-word"><%= word.hebrew %></p>
            <p class="french-word"><%= word.french %></p>
            <% if (word.transliteration) { %>
              <p class="translit"><em><%= word.transliteration %></em></p>
            <% } %>
          </div>
          <div class="word-card-flags">
            <% if (isGlobalInactive) { %>
              <span class="pill muted">Inactif global</span>
            <% } %>
          </div>
          <% if (currentUser) { %>
            <div class="word-card-actions inline-actions">
              <% if (currentUser.role === 'admin' || (word.user_id && Number(word.user_id) === Number(currentUser.id))) { %>
                <form method="post" action="/words/<%= word.id %>/toggle" style="display:inline;">
                  <input type="hidden" name="redirectTo" value="/themes/<%= theme.id %>">
                  <button class="btn ghost mini" type="submit"><%= Number(word.global_active) ? 'Désactiver (global)' : 'Activer (global)' %></button>
                </form>
              <% } %>
              <% if (Number(word.global_active) && currentUser.role !== 'admin') { %>
                <form method="post" action="/words/<%= word.id %>/toggle-self" style="display:inline;">
                  <input type="hidden" name="redirectTo" value="/themes/<%= theme.id %>">
                  <button class="btn ghost mini" type="submit"><%= isEffectiveActive ? 'Masquer pour moi' : 'Réactiver pour moi' %></button>
                </form>
              <% } %>
            </div>
          <% } %>
        </div>
      <% }) %>
    <% } %>
  </div>
</section>

<script>
  (() => {
    const tabs = Array.from(document.querySelectorAll('[data-tab]'));
    const cards = Array.from(document.querySelectorAll('.word-card'));
    const search = document.getElementById('word-search');
    let currentTab = 'all';
    const applyFilters = () => {
      const term = search ? search.value.trim().toLowerCase() : '';
      cards.forEach(card => {
        const isActive = card.dataset.active === '1';
        const matchesTab = currentTab === 'all' ? true : currentTab === 'active' ? isActive : !isActive;
        const matchesSearch = !term || (card.dataset.search || '').includes(term);
        card.style.display = matchesTab && matchesSearch ? '' : 'none';
      });
    };

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        applyFilters();
      });
    });

    if (search) {
      search.addEventListener('input', applyFilters);
    }

    applyFilters();
  })();
</script>
