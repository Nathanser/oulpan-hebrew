<% const memorizedCount = (cards || []).filter(c => Number(c.memorized)).length; %>
<% const pendingCount = (cards || []).length - memorizedCount; %>

<section class="card list-screen">
  <div class="list-screen-head">
    <div>
      <a class="link back-link" id="back-link" href="/my/lists">&#8592; Retour</a>
      <h1><%= set.name %></h1>
      <% if (Number(set.effective_active) === 0) { %>
        <p class="pill muted mini">Liste inactive pour toi</p>
      <% } %>
    </div>
    <div class="list-screen-actions">
      <% if ((typeof isOwner === 'undefined' || isOwner) || isCollaborator) { %>
        <a class="btn ghost" href="/my/lists/<%= set.id %>/edit">Modifier la liste</a>
      <% } %>
    </div>
  </div>

  <div class="tab-row" id="card-tabs">
    <button class="tab-chip active" data-tab="all">Toutes les cartes (<%= cards.length %>)</button>
    <button class="tab-chip" data-tab="memorized">Memorise (<%= memorizedCount %>)</button>
    <button class="tab-chip" data-tab="pending">Non memorise (<%= pendingCount %>)</button>
  </div>

  <div class="search-bar-row">
    <div class="search-row">
      <span class="search-icon">&#128269;</span>
      <input type="search" id="card-search" placeholder="Recherche (hebreu, francais, phonetique)" />
    </div>
    <% if (typeof isOwner === 'undefined' || isOwner) { %>
      <div class="search-actions">
        <button type="button" class="icon-btn ghost" id="select-toggle" title="Deplacer des cartes">&#x21C4;</button>
        <button type="button" class="icon-btn danger" id="select-cancel" style="display:none;" title="Annuler">&#10060;</button>
      </div>
    <% } %>
  </div>

  <div class="alert alert-error" id="select-banner" style="display:none;"></div>

  <div class="cards-wall" id="cards-wall">
    <% if (!cards || cards.length === 0) { %>
      <div class="wall-empty">
        <p>Aucun mot.</p>
      </div>
    <% } else { %>
      <% cards.forEach(card => { %>
        <div class="word-card <%= card.active ? '' : 'is-inactive' %>" data-active="<%= card.active ? 1 : 0 %>" data-memorized="<%= card.memorized ? 1 : 0 %>" data-search="<%= (card.hebrew + ' ' + card.french + ' ' + (card.transliteration || '')).toLowerCase() %>">
          <% if ((typeof isOwner === 'undefined' || isOwner) || isCollaborator) { %>
            <div class="word-card-top">
              <div class="word-card-actions">
                <a class="icon-btn ghost" href="/my/lists/<%= set.id %>/cards/<%= card.id %>/edit" title="Modifier la carte">&#9998;</a>
                <% if (typeof isOwner === 'undefined' || isOwner) { %>
                  <form method="post" action="/my/lists/<%= set.id %>/cards/<%= card.id %>/action">
                    <input type="hidden" name="action" value="toggle_fav" />
                    <input type="hidden" name="redirectTo" value="/my/lists/<%= set.id %>" />
                    <button type="submit" class="icon-btn heart <%= card.favorite ? 'active' : '' %>" title="Ajouter aux favoris">
                      &#10084;
                    </button>
                  </form>
                <% } %>
              </div>
              <label class="card-select">
                <input type="checkbox" class="card-check" value="<%= card.id %>" />
              </label>
            </div>
          <% } %>
          <div class="word-card-body">
            <p class="hebrew-word"><%= card.hebrew %></p>
            <p class="french-word"><%= card.french %></p>
            <% if (card.transliteration) { %>
              <p class="translit"><em><%= card.transliteration %></em></p>
            <% } %>
          </div>
          <div class="word-card-inline-actions">
            <% if ((typeof isOwner === 'undefined' || isOwner) || isCollaborator) { %>
              <form method="post" action="/my/lists/<%= set.id %>/cards/<%= card.id %>/action">
                <input type="hidden" name="action" value="toggle_active" />
                <input type="hidden" name="redirectTo" value="/my/lists/<%= set.id %>" />
                <button type="submit" class="icon-btn ghost" title="<%= card.active ? 'Masquer' : 'Rendre actif' %>">&#128065;</button>
              </form>
              <form method="post" action="/my/lists/<%= set.id %>/cards/<%= card.id %>/action">
                <input type="hidden" name="action" value="toggle_memorized" />
                <input type="hidden" name="redirectTo" value="/my/lists/<%= set.id %>" />
                <button type="submit" class="icon-btn ghost" title="Marquer memorise">&#129504;</button>
              </form>
              <% if (! (typeof isOwner === 'undefined' || isOwner) && isCollaborator) { %>
                <form method="post" action="/my/lists/<%= set.id %>/cards/<%= card.id %>/action">
                  <input type="hidden" name="action" value="toggle_fav" />
                  <input type="hidden" name="redirectTo" value="/my/lists/<%= set.id %>" />
                  <button type="submit" class="icon-btn heart <%= card.favorite ? 'active' : '' %>" title="Ajouter aux favoris">&#10084;</button>
                </form>
              <% } %>
              <% if (typeof isOwner === 'undefined' || isOwner) { %>
                <form method="post" action="/my/lists/<%= set.id %>/cards/<%= card.id %>/action" onsubmit="return confirm('Supprimer cette carte ?');">
                  <input type="hidden" name="action" value="delete" />
                  <input type="hidden" name="redirectTo" value="/my/lists/<%= set.id %>" />
                  <button type="submit" class="icon-btn ghost danger" title="Supprimer">&#128465;</button>
                </form>
              <% } %>
            <% } else { %>
              <form method="post" action="/my/lists/<%= set.id %>/cards/<%= card.id %>/action">
                <input type="hidden" name="action" value="toggle_fav" />
                <input type="hidden" name="redirectTo" value="/my/lists/<%= set.id %>" />
                <button type="submit" class="icon-btn heart <%= card.favorite ? 'active' : '' %>" title="Ajouter aux favoris">&#10084;</button>
              </form>
            <% } %>
          </div>
          <div class="word-card-flags">
            <% if (!card.active) { %><span class="pill muted">Inactif</span><% } %>
            <% if (card.memorized) { %><span class="pill success">Memorise</span><% } %>
            <% if (card.favorite) { %><span class="pill accent">Favori</span><% } %>
          </div>
        </div>
      <% }) %>
    <% } %>
  </div>

  <% if ((typeof isOwner === 'undefined' || isOwner) || isCollaborator) { %>
    <div class="list-bottom-actions fixed-actions">
      <button type="button" class="cta" id="main-action" data-edit-url="/my/lists/<%= set.id %>/edit">Ajouter des cartes</button>
      <button type="button" class="cta secondary" id="copy-action" style="display:none;">Copier</button>
      <button type="button" class="cta" id="move-action" style="display:none;">Deplacer</button>
      <a class="cta secondary" id="quiz-btn" href="/train?mode=flashcards&scope=mine">Lancer le quizz</a>
    </div>
  <% } %>
</section>

<% if (typeof isOwner === 'undefined' || isOwner) { %>
  <div class="modal-backdrop" id="move-modal" style="display:none;">
    <div class="modal-card">
      <h3 id="move-modal-title">Deplacer vers</h3>
      <% if (!otherSets || otherSets.length === 0) { %>
        <p class="muted">Pas d'autre liste disponible.</p>
      <% } else { %>
        <div class="options-list">
          <% otherSets.forEach(list => { %>
            <label class="option-row">
              <input type="radio" name="target_set" value="<%= list.id %>" />
              <span><%= list.name %></span>
            </label>
          <% }) %>
        </div>
      <% } %>
      <div class="alert alert-error" id="move-error" style="display:none;"></div>
      <div class="inline-actions modal-actions">
        <button type="button" class="btn" id="confirm-move">Valider</button>
        <button type="button" class="btn ghost" id="cancel-move">Annuler</button>
      </div>
    </div>
  </div>
  <form id="move-form" method="post" action="/my/lists/<%= set.id %>/move"></form>
  <form id="copy-form" method="post" action="/my/lists/<%= set.id %>/copy"></form>
<% } %>

<script>
  (() => {
    const isOwnerFlag = <%= (typeof isOwner === 'undefined' || isOwner) ? 'true' : 'false' %>;
    const isCollaboratorFlag = <%= isCollaborator ? 'true' : 'false' %>;
    const tabs = Array.from(document.querySelectorAll('[data-tab]'));
    const cards = Array.from(document.querySelectorAll('.word-card'));
    const search = document.getElementById('card-search');
    let currentTab = 'all';
    const applyFilters = () => {
      const term = search ? search.value.trim().toLowerCase() : '';
      cards.forEach(card => {
        const memo = card.dataset.memorized === '1';
        const matchesTab = currentTab === 'all' ? true : currentTab === 'memorized' ? memo : !memo;
        const matchesSearch = !term || (card.dataset.search || '').includes(term);
        card.style.display = matchesTab && matchesSearch ? '' : 'none';
      });
    };

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        applyFilters();
      });
    });

    if (search) {
      search.addEventListener('input', applyFilters);
    }

    if (isOwnerFlag) {
      const selectBtn = document.getElementById('select-toggle');
      const cancelSelectBtn = document.getElementById('select-cancel');
      const mainAction = document.getElementById('main-action');
      const copyAction = document.getElementById('copy-action');
      const moveAction = document.getElementById('move-action');
      const quizBtn = document.getElementById('quiz-btn');
      const backLink = document.getElementById('back-link');
      const banner = document.getElementById('select-banner');
      const modal = document.getElementById('move-modal');
      const modalTitle = document.getElementById('move-modal-title');
      const confirmMove = document.getElementById('confirm-move');
      const cancelMove = document.getElementById('cancel-move');
      const moveForm = document.getElementById('move-form');
      const copyForm = document.getElementById('copy-form');
      const moveError = document.getElementById('move-error');
      const cardChecks = Array.from(document.querySelectorAll('.card-check'));
      let selecting = false;
      let currentAction = 'move';

      const getSelectedIds = () => cardChecks.filter(cb => cb.checked).map(cb => cb.value);
      const showBanner = (msg) => {
        if (!banner) return;
        banner.textContent = msg;
        banner.style.display = 'block';
        setTimeout(() => { banner.style.display = 'none'; }, 2200);
      };

      const closeModal = () => {
        if (modal) modal.style.display = 'none';
        if (moveError) moveError.style.display = 'none';
      };

      const updateSelectionUI = () => {
        document.querySelectorAll('.word-card-actions, .word-card-inline-actions').forEach(el => {
          el.style.display = selecting ? 'none' : '';
        });
        document.querySelectorAll('.card-select').forEach(el => {
          el.style.display = selecting ? 'flex' : 'none';
        });
        if (backLink) backLink.style.display = selecting ? 'none' : '';
        if (quizBtn) quizBtn.style.display = selecting ? 'none' : '';
        if (selectBtn) selectBtn.style.display = selecting ? 'none' : '';
        if (cancelSelectBtn) cancelSelectBtn.style.display = selecting ? '' : 'none';
        if (mainAction) mainAction.style.display = selecting ? 'none' : '';
        if (quizBtn) quizBtn.style.display = selecting ? 'none' : '';
        if (copyAction) copyAction.style.display = selecting ? '' : 'none';
        if (moveAction) moveAction.style.display = selecting ? '' : 'none';
        const disabled = selecting && getSelectedIds().length === 0;
        [copyAction, moveAction].forEach(btn => {
          if (!btn) return;
          btn.classList.toggle('is-disabled', disabled);
          btn.dataset.disabled = disabled ? '1' : '0';
        });
      };

      const exitSelection = () => {
        selecting = false;
        cardChecks.forEach(cb => { cb.checked = false; });
        closeModal();
        updateSelectionUI();
      };

      if (selectBtn) {
        selectBtn.addEventListener('click', () => {
          selecting = true;
          updateSelectionUI();
        });
      }
      if (cancelSelectBtn) {
        cancelSelectBtn.addEventListener('click', exitSelection);
      }

      cardChecks.forEach(cb => {
        cb.addEventListener('change', () => {
          const disabled = getSelectedIds().length === 0;
          [copyAction, moveAction].forEach(btn => {
            if (!btn) return;
            btn.classList.toggle('is-disabled', disabled);
            btn.dataset.disabled = disabled ? '1' : '0';
          });
        });
      });

      const openModal = (mode) => {
        if (!selecting) return;
        if (getSelectedIds().length === 0) {
          showBanner('Selectionne au moins un mot.');
          return;
        }
        currentAction = mode;
        if (modalTitle) modalTitle.textContent = mode === 'copy' ? 'Copier vers' : 'Deplacer vers';
        if (modal) modal.style.display = 'flex';
      };

      if (mainAction) {
        mainAction.addEventListener('click', () => {
          const url = mainAction.getAttribute('data-edit-url');
          if (url) window.location.href = url;
        });
      }
      if (copyAction) {
        copyAction.addEventListener('click', (e) => {
          e.preventDefault();
          if (copyAction.dataset.disabled === '1') {
            showBanner('Selectionne au moins un mot.');
            return;
          }
          openModal('copy');
        });
      }
      if (moveAction) {
        moveAction.addEventListener('click', (e) => {
          e.preventDefault();
          if (moveAction.dataset.disabled === '1') {
            showBanner('Selectionne au moins un mot.');
            return;
          }
          openModal('move');
        });
      }

      if (cancelMove) {
        cancelMove.addEventListener('click', (e) => {
          e.preventDefault();
          closeModal();
        });
      }

      if (confirmMove && moveForm) {
        confirmMove.addEventListener('click', (e) => {
          e.preventDefault();
          const selected = getSelectedIds();
          if (selected.length === 0) {
            showBanner('Selectionne au moins un mot.');
            closeModal();
            return;
          }
          const target = document.querySelector('input[name="target_set"]:checked');
          if (!target) {
            if (moveError) {
              moveError.textContent = 'Choisis une destination.';
              moveError.style.display = 'block';
            }
            return;
          }
          const form = currentAction === 'copy' ? copyForm : moveForm;
          if (!form) return;
          form.innerHTML = '';
          selected.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'card_ids';
            input.value = id;
            form.appendChild(input);
          });
          const targetInput = document.createElement('input');
          targetInput.type = 'hidden';
          targetInput.name = 'target_set_id';
          targetInput.value = target.value;
          form.appendChild(targetInput);
          form.submit();
        });
      }

      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });
      }
    } else if (isCollaboratorFlag) {
      const mainAction = document.getElementById('main-action');
      if (mainAction) {
        mainAction.addEventListener('click', () => {
          const url = mainAction.getAttribute('data-edit-url');
          if (url) window.location.href = url;
        });
      }
    }

    applyFilters();
  })();
</script>
