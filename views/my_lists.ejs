<section>
    <div class="lists-topbar">
        <h1>Mes listes</h1>

        <style>
            .lists-topbar {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }

            .filter-container {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }

            .filter-label-text {
                font-size: 0.9rem;
                color: var(--text-muted, #888);
                margin-left: 2px;
            }

            .filter-controls {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 1rem;
                width: 100%;
            }

            .sort-form {
                flex: 1;
                margin: 0;
            }

            .sort-select {
                width: 100%;
                padding: 0.6rem;
                border-radius: 6px;
                background-color: var(--bg-card, #1e1e1e);
                color: var(--text-main, #fff);
                border: 1px solid var(--border-color, #333);
            }

            .create-btn {
                white-space: nowrap;
                padding: 0.6rem 1.2rem;
                background-color: #4CAF50;
                color: white;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 500;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                height: 100%;
            }

            @media (max-width: 480px) {
                .filter-controls {
                    gap: 0.5rem;
                }

                .create-btn {
                    padding: 0.6rem 0.8rem;
                    font-size: 0.9rem;
                }
            }
        </style>

        <div class="filter-container">
            <span class="filter-label-text">Filtrer par</span>
            <div class="filter-controls">
                <form method="get" action="/my/lists" class="sort-form">
                    <select name="sort" onchange="this.form.submit()" class="sort-select">
                        <option value="custom" <%=sort==='custom' ? "selected" : "" %>>
                            Ordre personnalisé
                        </option>
                        <option value="created_asc" <%=sort==='created_asc' ? "selected" : "" %>>
                            Date de création (plus anciennes)
                        </option>
                        <option value="created_desc" <%=sort==='created_desc' ? "selected" : "" %>>
                            Date de création (plus récentes)
                        </option>
                        <option value="alpha" <%=sort==='alpha' ? "selected" : "" %>>
                            Ordre alphabétique
                        </option>
                    </select>
                </form>
                <a class="create-btn" href="/my/lists/new">Créer une liste</a>
            </div>
        </div>
    </div>

    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
        <div class="segmented-control status-toggle" style="flex: 1;">
            <button type="button" class="seg-btn active" data-status-filter="active">Actives</button>
            <button type="button" class="seg-btn" data-status-filter="inactive">Inactives</button>
        </div>
        <button type="button" class="icon-btn ghost" id="lists-reorder-toggle" aria-label="Réordonner les listes"
            title="Réordonner les listes" style="height:2.3rem; width:2.4rem;" aria-pressed="false">
            <span class="menu-icon">⇵</span>
        </button>
    </div>

    <div data-tab-content="personal">
        <% if (!sets || sets.length===0) { %>
            <div class="card set-list-empty">
                <p>Pas encore de listes.</p>
            </div>
            <% } else { %>
                <div class="grid set-list-grid" id="personal-grid">
                    <% sets.forEach(set=> { %>
                        <div class="card set-list-card" data-set-id="<%= set.id %>"
                            data-active="<%= Number(set.effective_active) === 1 ? '1' : '0' %>">
                            <div class="set-list-top">
                                <div class="set-list-header">
                                    <h3>
                                        <%= set.name %>
                                    </h3>
                                    <div class="inline-actions">
                                        <button type="button" class="reorder-handle set-reorder-handle" data-drag-handle
                                            title="Réordonner cette liste" style="display:none;">&#9776;</button>
                                        <a class="btn ghost" href="/my/lists/<%= set.id %>">Ouvrir</a>

                                        <button type="button" class="icon-btn ghost dots-btn" data-menu-btn
                                            aria-label="Actions">&#8942;</button>
                                        <div class="card-menu" data-menu>
                                            <form action="/my/lists/<%= set.id %>/toggle-active" method="post">
                                                <button type="submit" class="menu-item">
                                                    <span>
                                                        <%= Number(set.effective_active)===0 ? 'Afficher' : 'Masquer' %>
                                                    </span>
                                                    <span class="menu-icon">&#128065;</span>
                                                </button>
                                            </form>
                                            <a href="/my/lists/<%= set.id %>/edit" class="menu-item">
                                                <span><strong>Modifier</strong></span>
                                                <span class="menu-icon">&#9998;</span>
                                            </a>
                                            <form action="/my/lists/<%= set.id %>/duplicate" method="post">
                                                <button type="submit" class="menu-item">
                                                    <span>Dupliquer</span>
                                                    <span class="menu-icon">&#128203;</span>
                                                </button>
                                            </form>
                                            <form action="/my/lists/<%= set.id %>?_method=DELETE" method="post"
                                                onsubmit="return confirm('Supprimer cette liste ?');">
                                                <button type="submit" class="menu-item danger">
                                                    <span>Supprimer</span>
                                                    <span class="menu-icon">&#128465;</span>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="set-list-meta">
                                    <p class="muted">
                                        <%= set.card_count %> carte<%= Number(set.card_count)> 1 ? 's' : '' %>
                                    </p>
                                    <% if (Number(set.effective_active)===1) { %>
                                        <span class="pill success mini status-pill">Actif</span>
                                        <% } else { %>
                                            <span class="pill muted mini status-pill">Inactif</span>
                                            <% } %>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                </div>
                <% } %>
    </div>
</section>

<script>
    (() => {
        // Menu handling
        const closeMenus = () => {
            document.querySelectorAll('.card-menu.open').forEach(m => m.classList.remove('open'));
        };
        document.querySelectorAll('[data-menu-btn]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = btn.parentElement.querySelector('[data-menu]');
                if (!menu) return;
                const isOpen = menu.classList.contains('open');
                closeMenus();
                if (!isOpen) menu.classList.add('open');
            });
        });
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.inline-actions')) closeMenus();
        });

        // Status filter toggle (Active/Inactive)
        const statusButtons = document.querySelectorAll('[data-status-filter]');
        const listCards = document.querySelectorAll('.set-list-card');
        let currentFilter = 'active';

        const applyStatusFilter = () => {
            listCards.forEach(card => {
                const isActive = card.dataset.active === '1';
                if (currentFilter === 'active') {
                    card.style.display = isActive ? '' : 'none';
                } else {
                    card.style.display = isActive ? 'none' : '';
                }
            });
        };

        statusButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                statusButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.statusFilter;
                applyStatusFilter();
            });
        });

        // Apply default filter on load
        applyStatusFilter();

        // Reorder Logic (similar to admin/themes)
        const HOLD_DELAY_MS = 300;
        const AUTO_SCROLL_EDGE = 110;
        const AUTO_SCROLL_STEP = 22;

        const reorderToggle = document.getElementById('lists-reorder-toggle');
        const grid = document.getElementById('personal-grid');
        let reorderMode = false;
        let dragState = null;

        const getOrder = () => {
            if (!grid) return [];
            return Array.from(grid.querySelectorAll('.set-list-card'))
                .map(card => Number(card.dataset.setId))
                .filter(id => Number.isInteger(id) && id > 0);
        };

        let lastOrder = getOrder();

        const ordersEqual = (a, b) => a.length === b.length && a.every((v, i) => v === b[i]);

        const updateSelectLock = () => {
            document.body.classList.toggle('no-text-select', reorderMode || !!dragState);
        };

        const setReorderMode = (active) => {
            if (!grid) return;
            reorderMode = active;
            if (active) {
                grid.dataset.mode = 'reorder';
            } else {
                delete grid.dataset.mode;
            }
            if (reorderToggle) {
                reorderToggle.classList.toggle('is-active', active);
                reorderToggle.innerHTML = active ? '&times;' : '<span class="menu-icon">⇵</span>';
                reorderToggle.setAttribute('aria-pressed', active ? 'true' : 'false');
            }
            // Toggle visibility of action buttons and drag handles
            grid.querySelectorAll('.set-list-card').forEach(card => {
                const openBtn = card.querySelector('a.btn.ghost');
                const dotsBtn = card.querySelector('.dots-btn');
                const dragHandle = card.querySelector('.reorder-handle');
                if (openBtn) openBtn.style.display = active ? 'none' : '';
                if (dotsBtn) dotsBtn.style.display = active ? 'none' : '';
                if (dragHandle) dragHandle.style.display = active ? '' : 'none';
            });
            closeMenus();
            updateSelectLock();
        };

        if (reorderToggle && (!grid || lastOrder.length <= 1)) {
            reorderToggle.disabled = true;
            reorderToggle.title = 'Aucune liste à réordonner';
        }

        const autoScroll = (clientY) => {
            if (clientY < AUTO_SCROLL_EDGE) {
                window.scrollBy({ top: -AUTO_SCROLL_STEP, behavior: 'auto' });
            } else if (clientY > window.innerHeight - AUTO_SCROLL_EDGE) {
                window.scrollBy({ top: AUTO_SCROLL_STEP, behavior: 'auto' });
            }
        };

        const placePlaceholder = (pageY) => {
            if (!dragState || !grid) return;
            const { card, placeholder } = dragState;
            const siblings = Array.from(grid.querySelectorAll('.set-list-card')).filter(el => el !== card);
            let placed = false;
            for (const sibling of siblings) {
                const rect = sibling.getBoundingClientRect();
                const middle = rect.top + window.scrollY + rect.height / 2;
                if (pageY < middle) {
                    grid.insertBefore(placeholder, sibling);
                    placed = true;
                    break;
                }
            }
            if (!placed) grid.appendChild(placeholder);
        };

        const persistOrder = async (order) => {
            if (!order || order.length === 0 || ordersEqual(order, lastOrder)) return;
            try {
                if (reorderToggle) {
                    reorderToggle.setAttribute('disabled', 'disabled');
                    reorderToggle.classList.add('loading');
                }
                const res = await fetch('/my/lists/reorder-ids', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ordered_ids: order })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data || data.success !== true) {
                    throw new Error('save failed');
                }
                lastOrder = order.slice();
                window.location.reload();
            } catch (err) {
                alert('Impossible de sauvegarder le nouvel ordre.');
                console.error(err);
            } finally {
                if (reorderToggle && grid) {
                    reorderToggle.removeAttribute('disabled');
                    reorderToggle.classList.remove('loading');
                }
            }
        };

        const finishDrag = () => {
            if (!dragState || !grid) return;
            const { card, placeholder } = dragState;
            card.classList.remove('dragging');
            card.removeAttribute('style');
            grid.insertBefore(card, placeholder);
            placeholder.remove();
            dragState = null;
            const order = getOrder();
            updateSelectLock();
            card.classList.add('drag-settled');
            setTimeout(() => card.classList.remove('drag-settled'), 320);
            persistOrder(order);
        };

        const startDrag = (card, startEvt) => {
            if (dragState || !reorderMode || !grid) return;
            const rect = card.getBoundingClientRect();
            const placeholder = document.createElement('div');
            placeholder.className = 'card-placeholder';
            placeholder.style.height = `${rect.height}px`;
            dragState = {
                card,
                placeholder,
                offsetY: startEvt.clientY - rect.top,
                left: rect.left
            };
            grid.insertBefore(placeholder, card.nextElementSibling);

            card.classList.add('dragging');
            updateSelectLock();
            card.style.width = `${rect.width}px`;
            card.style.height = `${rect.height}px`;
            card.style.left = `${rect.left}px`;
            card.style.top = `${rect.top}px`;
            card.style.position = 'fixed';
            card.style.pointerEvents = 'none';
            card.style.zIndex = '60';

            const onMove = (e) => {
                e.preventDefault();
                const clientY = e.clientY;
                if (!Number.isFinite(clientY)) return;
                card.style.top = `${clientY - dragState.offsetY}px`;
                card.style.left = `${dragState.left}px`;
                autoScroll(clientY);
                placePlaceholder(clientY + window.scrollY);
            };

            const onUp = () => {
                document.removeEventListener('pointermove', onMove);
                document.removeEventListener('pointerup', onUp);
                finishDrag();
            };

            document.addEventListener('pointermove', onMove);
            document.addEventListener('pointerup', onUp);
        };

        const attachDrag = (card) => {
            card.addEventListener('pointerdown', (e) => {
                if (!reorderMode) return;
                if (!e.target.closest('[data-drag-handle]')) return;
                if (e.button !== 0 && e.pointerType !== 'touch') return;
                if (e.pointerType === 'touch') {
                    e.preventDefault();
                }

                const startEvt = e;
                let moved = false;

                const detectMove = (moveEvt) => {
                    if (
                        Math.abs(moveEvt.clientY - startEvt.clientY) > 6 ||
                        Math.abs(moveEvt.clientX - startEvt.clientX) > 6
                    ) {
                        moved = true;
                    }
                };

                const cancel = () => {
                    clearTimeout(timer);
                    document.removeEventListener('pointermove', detectMove);
                    document.removeEventListener('pointerup', cancel);
                };

                const timer = setTimeout(() => {
                    if (!moved) startDrag(card, startEvt);
                    cancel();
                }, HOLD_DELAY_MS);

                document.addEventListener('pointermove', detectMove);
                document.addEventListener('pointerup', cancel);
            });
        };

        if (grid) {
            grid.querySelectorAll('.set-list-card').forEach(card => attachDrag(card));
        }

        if (reorderToggle) {
            reorderToggle.addEventListener('click', () => {
                if (!grid) return;
                setReorderMode(!reorderMode);
            });
        }
    })();
</script>