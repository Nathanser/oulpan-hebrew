<section>
    <div class="lists-topbar">
        <h1>Mes listes</h1>

        <style>
            .lists-topbar {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }

            .filter-container {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }

            .filter-label-text {
                font-size: 0.9rem;
                color: var(--text-muted, #888);
                margin-left: 2px;
            }

            .filter-controls {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 1rem;
                width: 100%;
            }

            .sort-form {
                flex: 1;
                margin: 0;
            }

            .sort-select {
                width: 100%;
                padding: 0.6rem;
                border-radius: 6px;
                background-color: var(--bg-card, #1e1e1e);
                color: var(--text-main, #fff);
                border: 1px solid var(--border-color, #333);
            }

            .create-btn {
                white-space: nowrap;
                padding: 0.6rem 1.2rem;
                background-color: #4CAF50;
                color: white;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 500;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                height: 100%;
            }

            @media (max-width: 480px) {
                .filter-controls {
                    gap: 0.5rem;
                }

                .create-btn {
                    padding: 0.6rem 0.8rem;
                    font-size: 0.9rem;
                }
            }
        </style>

        <div class="filter-container">
            <span class="filter-label-text">Filtrer par</span>
            <div class="filter-controls">
                <form method="get" action="/my/lists" class="sort-form">
                    <select name="sort" onchange="this.form.submit()" class="sort-select">
                        <option value="custom" <%=sort==='custom' ? "selected" : "" %>>
                            Ordre personnalisé
                        </option>
                        <option value="created_asc" <%=sort==='created_asc' ? "selected" : "" %>>
                            Date de création (plus anciennes)
                        </option>
                        <option value="created_desc" <%=sort==='created_desc' ? "selected" : "" %>>
                            Date de création (plus récentes)
                        </option>
                        <option value="alpha" <%=sort==='alpha' ? "selected" : "" %>>
                            Ordre alphabétique
                        </option>
                    </select>
                </form>
                <a class="create-btn" href="/my/lists/new">Créer une liste</a>
            </div>
        </div>
    </div>

    <div data-tab-content="personal">
        <% if (!sets || sets.length===0) { %>
            <div class="card set-list-empty">
                <p>Pas encore de listes.</p>
            </div>
            <% } else { %>
                <div class="grid set-list-grid" id="personal-grid">
                    <% sets.forEach(set=> { %>
                        <div class="card set-list-card" data-set-id="<%= set.id %>">
                            <div class="set-list-top">
                                <div class="set-list-header">
                                    <h3>
                                        <%= set.name %>
                                    </h3>
                                    <div class="inline-actions">
                                        <a class="btn ghost" href="/my/lists/<%= set.id %>">Ouvrir</a>

                                        <button type="button" class="icon-btn ghost dots-btn" data-menu-btn
                                            aria-label="Actions">&#8942;</button>
                                        <div class="card-menu" data-menu>
                                            <form action="/my/lists/<%= set.id %>/toggle-active" method="post">
                                                <button type="submit" class="menu-item">
                                                    <span>
                                                        <%= Number(set.effective_active)===0 ? 'Afficher'
                                                            : 'Masquer' %>
                                                    </span>
                                                    <span class="menu-icon">&#128065;</span>
                                                </button>
                                            </form>
                                            <a href="/my/lists/<%= set.id %>/edit" class="menu-item">
                                                <span>Modifier</span>
                                                <span class="menu-icon">&#9998;</span>
                                            </a>
                                            <form action="/my/lists/<%= set.id %>/duplicate" method="post">
                                                <button type="submit" class="menu-item">
                                                    <span>Dupliquer</span>
                                                    <span class="menu-icon">&#128203;</span>
                                                </button>
                                            </form>
                                            <form action="/my/lists/<%= set.id %>?_method=DELETE" method="post"
                                                onsubmit="return confirm('Supprimer cette liste ?');">
                                                <button type="submit" class="menu-item danger">
                                                    <span>Supprimer</span>
                                                    <span class="menu-icon">&#128465;</span>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="set-list-meta">
                                    <p class="muted">
                                        <%= set.card_count %> carte<%= Number(set.card_count)> 1 ? 's' : '' %>
                                    </p>
                                    <% if (Number(set.effective_active)===1) { %>
                                        <span class="pill success mini status-pill">Actif</span>
                                        <% } else { %>
                                            <span class="pill muted mini status-pill">Inactif</span>
                                            <% } %>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                </div>
                <% } %>
    </div>
</section>

<script>
    (() => {
        // Menu handling
        const closeMenus = () => {
            document.querySelectorAll('.card-menu.open').forEach(m => m.classList.remove('open'));
        };
        document.querySelectorAll('[data-menu-btn]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = btn.parentElement.querySelector('[data-menu]');
                if (!menu) return;
                const isOpen = menu.classList.contains('open');
                closeMenus();
                if (!isOpen) menu.classList.add('open');
            });
        });
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.inline-actions')) closeMenus();
        });

        // Drag and Drop Logic
        const personalGrid = document.getElementById('personal-grid');
        // Only enable drag if sort is custom
        const sortSelect = document.querySelector('select[name="sort"]');
        const isCustomSort = sortSelect && sortSelect.value === 'custom';

        if (!isCustomSort) return;

        let dragState = null;
        const HOLD_DELAY_MS = 150;
        const AUTO_SCROLL_EDGE = 100;
        const AUTO_SCROLL_STEP = 10;

        const startDrag = (card, startEvt) => {
            // Prevent drag on buttons
            if (startEvt.target.closest('button') || startEvt.target.closest('a') || startEvt.target.closest('.card-menu')) return;

            const rect = card.getBoundingClientRect();
            const placeholder = card.cloneNode(true);
            placeholder.style.opacity = '0';
            placeholder.classList.add('drag-placeholder');

            card.style.position = 'fixed';
            card.style.zIndex = '9999';
            card.style.width = `${rect.width}px`;
            card.style.height = `${rect.height}px`;
            card.style.left = `${rect.left}px`;
            card.style.top = `${rect.top}px`;
            card.classList.add('dragging');

            card.parentNode.insertBefore(placeholder, card);
            document.body.appendChild(card);

            const offsetX = startEvt.clientX - rect.left;
            const offsetY = startEvt.clientY - rect.top;

            dragState = { card, placeholder, offsetX, offsetY, startX: startEvt.clientX, startY: startEvt.clientY };

            const moveHandler = (e) => {
                if (!dragState) return;
                e.preventDefault();
                const x = e.clientX - dragState.offsetX;
                const y = e.clientY - dragState.offsetY;
                card.style.left = `${x}px`;
                card.style.top = `${y}px`;

                // Auto scroll
                if (e.clientY < AUTO_SCROLL_EDGE) {
                    window.scrollBy(0, -AUTO_SCROLL_STEP);
                } else if (e.clientY > window.innerHeight - AUTO_SCROLL_EDGE) {
                    window.scrollBy(0, AUTO_SCROLL_STEP);
                }

                // Reorder logic
                const siblings = Array.from(personalGrid.children).filter(c => c !== placeholder && c.style.display !== 'none');
                const mouseY = e.clientY;

                let inserted = false;
                for (const sibling of siblings) {
                    const sibRect = sibling.getBoundingClientRect();
                    const middle = sibRect.top + sibRect.height / 2;
                    if (mouseY < middle) {
                        personalGrid.insertBefore(placeholder, sibling);
                        inserted = true;
                        break;
                    }
                }
                if (!inserted) {
                    personalGrid.appendChild(placeholder);
                }
            };

            const upHandler = () => {
                document.removeEventListener('pointermove', moveHandler);
                document.removeEventListener('pointerup', upHandler);

                if (!dragState) return;

                // Finalize drop
                const { card, placeholder } = dragState;

                // Animate back to placeholder
                const dest = placeholder.getBoundingClientRect();
                card.style.transition = 'all 0.2s ease';
                card.style.left = `${dest.left}px`;
                card.style.top = `${dest.top}px`;

                setTimeout(() => {
                    card.style.position = '';
                    card.style.zIndex = '';
                    card.style.width = '';
                    card.style.height = '';
                    card.style.left = '';
                    card.style.top = '';
                    card.style.transition = '';
                    card.classList.remove('dragging');

                    if (placeholder.parentNode) {
                        placeholder.parentNode.replaceChild(card, placeholder);
                    } else {
                        personalGrid.appendChild(card);
                    }

                    dragState = null;

                    // Save order
                    saveOrder();
                }, 200);
            };

            document.addEventListener('pointermove', moveHandler);
            document.addEventListener('pointerup', upHandler);
        };

        const attachDrag = (card) => {
            card.addEventListener('pointerdown', (e) => {
                if (e.button !== 0) return; // Only left click

                // Delay to distinguish click from drag
                let moved = false;
                const startX = e.clientX;
                const startY = e.clientY;

                const checkMove = (m) => {
                    if (Math.abs(m.clientX - startX) > 5 || Math.abs(m.clientY - startY) > 5) moved = true;
                };
                document.addEventListener('pointermove', checkMove);

                const timer = setTimeout(() => {
                    document.removeEventListener('pointermove', checkMove);
                    if (!moved) startDrag(card, e);
                }, HOLD_DELAY_MS);

                const cancel = () => {
                    clearTimeout(timer);
                    document.removeEventListener('pointermove', checkMove);
                    document.removeEventListener('pointerup', cancel);
                };
                document.addEventListener('pointerup', cancel);
            });
        };

        if (isCustomSort && personalGrid) {
            personalGrid.querySelectorAll('.set-list-card').forEach(attachDrag);
        }

        const saveOrder = () => {
            const ids = Array.from(personalGrid.querySelectorAll('.set-list-card')).map(c => c.dataset.setId);
            fetch('/my/lists/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids })
            }).catch(err => console.error('Reorder failed', err));
        };

    })();
</script>


