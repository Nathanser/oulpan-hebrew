<% 
  const f = filters || {};
  const themeIdsString = (f.theme_ids || []).join(',');
  const setIdsString = (f.set_ids || []).join(',');
  const isAll = total === 'all' || remaining === 'all';
  const remainingCount = isAll ? 'all' : (typeof remaining !== 'undefined' ? Number(remaining) : 10);
  const totalCount = isAll ? 'all' : (typeof total !== 'undefined' ? Number(total) : remainingCount);
  const answeredCount = typeof answered !== 'undefined'
    ? Number(answered)
    : (isAll ? 0 : (totalCount - remainingCount + (word ? 1 : 0)));
  const correctCount = typeof correct !== 'undefined' ? Number(correct) : 0;
  const currentStep = isAll
    ? (answeredCount + (word ? 1 : 0))
    : (totalCount - remainingCount + (word ? 1 : 0));
  const totalLabel = isAll ? 'tout' : totalCount;
%>

<section class="card session-card">
  <div class="session-top">
    <a class="icon-btn" href="/train/setup">&#8592;</a>
    <div class="session-progress">
      <span><%= currentStep %>/<%= totalLabel %></span>
      <span class="pill"><%= mode === 'flashcards' ? 'Flashcards' : 'Quiz' %></span>
    </div>
    <a class="icon-btn" href="/train/setup">&#9881;</a>
  </div>

  <% if (word && (!f.source || f.source !== 'cards')) { %>
    <form method="post" action="/favorites/<%= word.id %>" class="fav-form">
      <input type="hidden" name="redirectTo" value="/train?mode=<%= mode %>">
      <button type="submit" class="icon-btn ghost">&#9829;</button>
    </form>
  <% } %>

  <% if (message) { %>
    <p><%= message %></p>
  <% } %>

  <% if (word && mode === 'quiz') { %>
    <div class="quiz">
      <p class="quiz-label">Traduire en hebreu :</p>
      <p class="quiz-word"><%= word.french %></p>

      <form method="post" action="/train/answer" class="form">
        <input type="hidden" name="word_id" value="<%= word.id %>" />
        <label>Votre reponse (hebreu)
          <input type="text" name="user_answer" autocomplete="off" required />
        </label>
        <button type="submit">Valider</button>
      </form>
    </div>
  <% } %>

  <% if (word && mode === 'flashcards') { %>
    <div class="flashcard" id="flashcard">
      <p class="flashcard-label">Hebreu</p>
      <p class="flashcard-word"><%= word.hebrew %></p>
      <% if (word.transliteration) { %>
        <p class="flashcard-sub"><%= word.transliteration %></p>
      <% } %>
      <p class="flashcard-hint">Choisis la bonne traduction</p>
    </div>

    <form method="post" action="/train/flashcards" class="flashcard-options">
      <input type="hidden" name="word_id" value="<%= word.id %>" />
      <div class="options-grid">
        <% (options || []).forEach(opt => { %>
          <button type="submit" name="choice_word_id" value="<%= opt.id %>" class="option-btn"><%= opt.french %></button>
        <% }) %>
      </div>
    </form>
  <% } %>

  <% if (result) { %>
    <div class="result <%= result.isCorrect ? 'success' : 'error' %>">
      <% if (result.isCorrect) { %>
        <p>Bonne reponse !</p>
      <% } else { %>
        <p>Mauvaise reponse.</p>
      <% } %>
      <p>Mot : <strong><%= result.correctAnswer %></strong></p>
      <% if (result.transliteration) { %>
        <p>Transliteration : <%= result.transliteration %></p>
      <% } %>
      <p>Francais : <%= result.french %></p>
    </div>
    <% if (nextUrl) { %>
      <a class="btn" href="<%= nextUrl %>">Suivant</a>
    <% } else { %>
      <div class="result success">
        <p>Session terminee.</p>
        <p>Score : <strong><%= correctCount %>/<%= totalLabel %></strong></p>
      </div>
    <% } %>
  <% } %>

  <% if (!word && !result && !message) { %>
    <p>Aucun mot a reviser avec ces parametres.</p>
  <% } %>
</section>
