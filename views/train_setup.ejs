<section class="card">
  <div class="list-header">
    <h2>Choix de la révision</h2>
  </div>

  <% let selectedModes=['flashcards']; if (params && params.modes) { selectedModes=Array.isArray(params.modes) ?
    params.modes : [params.modes]; } let selectedThemes=new Set(); if (params && params.theme_ids) { const
    ids=Array.isArray(params.theme_ids) ? params.theme_ids : [params.theme_ids]; ids.forEach(id=>
    selectedThemes.add(String(id)));
    }

    let selectedSets = new Set();
    if (params && params.set_ids) {
    const ids = Array.isArray(params.set_ids) ? params.set_ids : [params.set_ids];
    ids.forEach(id => selectedSets.add(String(id)));
    }

    let selectedRemaining = 'all';
    if (params && typeof params.remaining !== 'undefined') {
    selectedRemaining = String(params.remaining);
    }
    if (selectedRemaining === '10') selectedRemaining = 'all';

    const selectedRevMode = (params && typeof params.rev_mode !== 'undefined') ? String(params.rev_mode) : 'order';
    const selectedPhonetic = (params && typeof params.show_phonetic !== 'undefined') ? String(params.show_phonetic) :
    '1';
    const selectedLevel = (params && params.level_id) ? String(params.level_id) : '';
    %>

    <form class="form setup-grid" action="/train/session" method="post" id="setup-form"
      data-levels="<%= JSON.stringify(levels || []) %>"
      data-selected-themes="<%= JSON.stringify(Array.from(selectedThemes)) %>"
      data-selected-sets="<%= JSON.stringify(Array.from(selectedSets)) %>"
      data-selected-level="<%= JSON.stringify(selectedLevel || '') %>"
      data-selected-remaining="<%= JSON.stringify(selectedRemaining) %>">

      <% if (typeof error !=='undefined' && error) { %>
        <div class="alert alert-error">
          <%= error %>
        </div>
        <% } %>

          <div class="field-block">
            <div class="field-title">Modes de révision</div>
            <div class="mode-grid">
              <label class="check-row">
                <input type="checkbox" name="modes[]" value="flashcards" <%=selectedModes.includes('flashcards')
                  ? 'checked' : '' %>>
                <span>Flashcards classique</span>
              </label>
              <label class="check-row">
                <input type="checkbox" name="modes[]" value="flashcards_reverse"
                  <%=selectedModes.includes('flashcards_reverse') ? 'checked' : '' %>>
                <span>Flashcards reverse</span>
              </label>
              <label class="check-row">
                <input type="checkbox" name="modes[]" value="written" <%=selectedModes.includes('written') ? 'checked'
                  : '' %>>
                <span>Révision par écrit</span>
              </label>
            </div>
          </div>

          <div class="field-block">
            <div class="field-title">Thèmes et listes</div>
            <div class="theme-toggles inline">
              <label class="check-row"><input type="checkbox" id="toggle-public" <%=selectedThemes.size> 0 ? 'checked' :
                '' %>> <span>Thèmes en ligne</span></label>
              <label class="check-row"><input type="checkbox" id="toggle-lists" <%=(sets || []).some(s=>
                selectedSets.has(String(s.id))) ? 'checked' : '' %>> <span>Mes listes</span></label>
              <label class="check-row"><input type="checkbox" id="toggle-shared" <%=(sharedSets || []).some(s=>
                selectedSets.has(String(s.id))) ? 'checked' : '' %>> <span>Listes partagées</span></label>
            </div>

            <div class="theme-groups">
              <div class="theme-group" id="public-group" style="display:none;">
                <p class="muted mini" style="margin:0 0 0.2rem;">Thèmes en ligne</p>
                <% if (!themes || themes.length===0) { %>
                  <p class="muted mini">Aucun thème en ligne disponible.</p>
                  <% } else { %>
                    <ul class="custom-select-container">
                      <% themes.forEach(t=> { %>
                        <% if (t.children && t.children.length> 0) { %>
                          <li>
                            <div class="theme-row parent-row">
                              <button type="button" class="icon-btn ghost toggle-subthemes-btn"
                                data-target="subthemes-<%= t.id %>" aria-expanded="false">
                                <span class="chevron-icon">&#9654;</span>
                              </button>
                              <span class="theme-label">
                                <%= t.name %>
                              </span>
                            </div>
                            <ul id="subthemes-<%= t.id %>" style="display:none;">
                              <% t.children.forEach(child=> { %>
                                <li>
                                  <div class="theme-row">
                                    <input type="checkbox" name="theme_ids[]" value="<%= child.id %>"
                                      id="theme-<%= child.id %>" <%=selectedThemes.has(String(child.id)) ? 'checked'
                                      : '' %>>
                                    <label for="theme-<%= child.id %>">
                                      <%= child.name %>
                                    </label>
                                  </div>
                                </li>
                                <% }) %>
                            </ul>
                          </li>
                          <% } else { %>
                            <li>
                              <div class="theme-row">
                                <input type="checkbox" name="theme_ids[]" value="<%= t.id %>" id="theme-<%= t.id %>"
                                  <%=selectedThemes.has(String(t.id)) ? 'checked' : '' %>>
                                <label for="theme-<%= t.id %>">
                                  <%= t.name %>
                                </label>
                              </div>
                            </li>
                            <% } %>
                              <% }) %>
                    </ul>
                    <% } %>
              </div>

              <div class="theme-group" id="list-group" style="display:none;">
                <p class="muted mini" style="margin:0 0 0.2rem;">Mes Listes</p>
                <% if (!sets || sets.length===0) { %>
                  <p class="muted mini">Aucune liste pour le moment.</p>
                  <% } else { %>
                    <ul class="custom-select-container">
                      <% sets.forEach(s=> { %>
                        <li>
                          <div class="theme-row">
                            <input type="checkbox" name="set_ids[]" value="<%= s.id %>" id="set-<%= s.id %>"
                              <%=selectedSets.has(String(s.id)) ? 'checked' : '' %>>
                            <label for="set-<%= s.id %>">
                              <%= s.name %>
                            </label>
                          </div>
                        </li>
                        <% }) %>
                    </ul>
                    <% } %>
              </div>

              <div class="theme-group" id="shared-list-group" style="display:none;">
                <p class="muted mini" style="margin:0 0 0.2rem;">Listes partagées</p>
                <% if (!sharedSets || sharedSets.length===0) { %>
                  <p class="muted mini">Aucune liste partagée.</p>
                  <% } else { %>
                    <ul class="custom-select-container">
                      <% sharedSets.forEach(s=> { %>
                        <li>
                          <div class="theme-row">
                            <input type="checkbox" name="set_ids[]" value="<%= s.id %>" id="shared-set-<%= s.id %>"
                              <%=selectedSets.has(String(s.id)) ? 'checked' : '' %>>
                            <label for="shared-set-<%= s.id %>">
                              <%= s.name %> (<%= s.owner_name %>)
                            </label>
                          </div>
                        </li>
                        <% }) %>
                    </ul>
                    <% } %>
              </div>
            </div>
          </div>

          <div class="field-block" id="level-field" style="display:none;">
            <label>Niveau
              <select name="level_id" id="level-select">
                <option value="">(Tous les niveaux)</option>
              </select>
            </label>
          </div>

          <div class="field-block">
            <div class="field-title">Nombre de mots</div>
            <div class="mode-grid">
              <label class="check-row">
                <input type="radio" name="remaining_mode" value="all" id="rm-all" <%=selectedRemaining==='all'
                  ? 'checked' : '' %>>
                <span style="white-space: nowrap;">Tout le thème/liste</span>
              </label>
              <label class="check-row">
                <input type="radio" name="remaining_mode" value="custom" id="rm-custom" <%=selectedRemaining !=='all'
                  ? 'checked' : '' %>>
                <span style="white-space: nowrap;">Nombre défini</span>
              </label>
            </div>
            <div id="slider-container" style="display:none; margin-top:0.5rem; padding-left:0.5rem;">
              <div style="display:flex; align-items:center; gap:0.75rem;">
                <input type="range" min="1" max="50"
                  value="<%= selectedRemaining !== 'all' ? selectedRemaining : '10' %>" id="remaining-slider"
                  style="flex:1; cursor:pointer;">
                <span id="slider-val" style="font-weight:700; min-width:1.5rem; text-align:right;">
                  <%= selectedRemaining !=='all' ? selectedRemaining : '10' %>
                </span>
              </div>
            </div>
            <input type="hidden" name="remaining" id="remaining-input" value="<%= selectedRemaining %>">
            <input type="hidden" name="total"
              value="<%= (params && typeof params.total !== 'undefined') ? params.total : 10 %>">
          </div>

          <details class="advanced">
            <summary style="padding-bottom: 0.3rem">Options avancées</summary>
            <div class="advanced-grid">
              <label>Mode de révision
                <select name="rev_mode">
                  <option value="order" <%=selectedRevMode==='order' ? 'selected' : '' %>>Dans l'ordre</option>
                  <option value="random" <%=selectedRevMode==='random' ? 'selected' : '' %>>Aléatoire</option>
                  <option value="favorites" <%=selectedRevMode==='favorites' ? 'selected' : '' %>>Favoris</option>
                  <option value="new" <%=selectedRevMode==='new' ? 'selected' : '' %>>Nouveaux mots</option>
                  <option value="weak" <%=selectedRevMode==='weak' ? 'selected' : '' %>>Mots faibles / Non maîtrisés
                  </option>
                </select>
              </label>
              <fieldset class="check-row">
                <legend style="margin-bottom:0.35rem;">Phonétique ?</legend>
                <label class="check-row">
                  <input type="radio" name="show_phonetic" value="1" <%=selectedPhonetic !=='0' ? 'checked' : '' %>>
                  <span>Oui</span>
                </label>
                <label class="check-row">
                  <input type="radio" name="show_phonetic" value="0" <%=selectedPhonetic==='0' ? 'checked' : '' %>>
                  <span>Non</span>
                </label>
              </fieldset>
            </div>
          </details>

          <button type="submit">Démarrer</button>
    </form>
</section>

<script>
  (() => {
    const form = document.getElementById('setup-form');
    if (!form) return;

    const levelsData = JSON.parse(form.dataset.levels || '[]');
    const preselectedLevel = JSON.parse(form.dataset.selectedLevel || '""');
    const selectedRemainingValue = JSON.parse(form.dataset.selectedRemaining || '"all"');

    const levelSelect = document.getElementById('level-select');
    const levelField = document.getElementById('level-field');
    const publicGroup = document.getElementById('public-group');
    const listGroup = document.getElementById('list-group');
    const sharedListGroup = document.getElementById('shared-list-group');
    const togglePublic = document.getElementById('toggle-public');
    const toggleLists = document.getElementById('toggle-lists');
    const toggleShared = document.getElementById('toggle-shared');

    const renderLevels = () => {
      const checkedInputs = document.querySelectorAll('input[name="theme_ids[]"]:checked');
      const checkedThemes = Array.from(checkedInputs).map(cb => cb.value);

      levelSelect.innerHTML = '<option value="">(Tous les niveaux)</option>';

      if (checkedThemes.length !== 1) {
        levelField.style.display = 'none';
        return;
      }

      const filtered = levelsData.filter(l => String(l.theme_id) === String(checkedThemes[0]));
      if (filtered.length === 0) {
        levelField.style.display = 'none';
        return;
      }
      filtered.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id;
        opt.textContent = l.name;
        levelSelect.appendChild(opt);
      });
      levelField.style.display = 'block';
    };

    const updateGroups = () => {
      if (publicGroup) publicGroup.style.display = togglePublic && togglePublic.checked ? 'block' : 'none';
      if (listGroup) listGroup.style.display = toggleLists && toggleLists.checked ? 'block' : 'none';
      if (sharedListGroup) sharedListGroup.style.display = toggleShared && toggleShared.checked ? 'block' : 'none';
      renderLevels();
    };

    const updateSliderFill = () => {
      if (!slider) return;
      const percentage = ((slider.value - 1) / 49) * 100;
      slider.style.setProperty('--slider-fill', `${percentage}%`);
    };

    const updateRemainingUI = () => {
      if (rmAll && rmAll.checked) {
        if (sliderContainer) sliderContainer.style.display = 'none';
        if (remainingInput) remainingInput.value = 'all';
      } else {
        if (sliderContainer) sliderContainer.style.display = 'block';
        if (remainingInput && slider) remainingInput.value = slider.value;
        updateSliderFill();
      }
    };

    document.querySelectorAll('input[name="theme_ids[]"]').forEach(cb => {
      cb.addEventListener('change', renderLevels);
    });

    if (togglePublic) togglePublic.addEventListener('change', updateGroups);
    if (toggleLists) toggleLists.addEventListener('change', updateGroups);
    if (toggleShared) toggleShared.addEventListener('change', updateGroups);

    const rmAll = document.getElementById('rm-all');
    const rmCustom = document.getElementById('rm-custom');
    const sliderContainer = document.getElementById('slider-container');
    const slider = document.getElementById('remaining-slider');
    const sliderVal = document.getElementById('slider-val');
    const remainingInput = document.getElementById('remaining-input');

    if (rmAll) rmAll.addEventListener('change', updateRemainingUI);
    if (rmCustom) rmCustom.addEventListener('change', updateRemainingUI);
    if (slider) {
      slider.addEventListener('input', () => {
        if (sliderVal) sliderVal.textContent = slider.value;
        if (remainingInput) remainingInput.value = slider.value;
        updateSliderFill();
      });
    }

    updateGroups();
    if (preselectedLevel && levelSelect) levelSelect.value = preselectedLevel;
    updateRemainingUI();

    form.addEventListener('submit', () => {
      const modeInputs = Array.from(document.querySelectorAll('input[name="modes[]"]'));
      if (!modeInputs.some(i => i.checked) && modeInputs[0]) modeInputs[0].checked = true;
    });

    // Toggle subthemes visibility
    document.querySelectorAll('.toggle-subthemes-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = btn.dataset.target;
        const target = document.getElementById(targetId);
        const icon = btn.querySelector('.chevron-icon');
        if (target) {
          const isHidden = target.style.display === 'none';
          target.style.display = isHidden ? 'block' : 'none';
          btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
          icon.innerHTML = isHidden ? '&#9660;' : '&#9654;';
        }
      });
    });

    // Allow clicking parent label to toggle open/close
    document.querySelectorAll('.theme-row.parent-row .theme-label').forEach(label => {
      const parentRow = label.closest('.parent-row');
      const btn = parentRow ? parentRow.querySelector('.toggle-subthemes-btn') : null;
      if (!btn) return;
      label.addEventListener('click', () => btn.click());
    });

    // Ensure already-selected subthemes are visible on load
    document.querySelectorAll('.toggle-subthemes-btn').forEach(btn => {
      const target = document.getElementById(btn.dataset.target);
      const icon = btn.querySelector('.chevron-icon');
      if (!target) return;
      const hasCheckedChild = target.querySelector('input[type="checkbox"]:checked');
      if (hasCheckedChild) {
        target.style.display = 'block';
        btn.setAttribute('aria-expanded', 'true');
        if (icon) icon.innerHTML = '&#9660;';
      }
    });

  })();
</script>

<style>
  .custom-select-container {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    padding: 0.75rem 0.85rem;
    max-height: 190px;
    overflow-y: auto;
    list-style: none;
    margin: 0;
    border: 1px solid var(--border-main);
    border-radius: 0.85rem;
    background: var(--bg-card);
  }

  .custom-select-container>li {
    list-style: none;
    margin: 0;
  }

  .theme-row {
    display: grid;
    grid-template-columns: auto 1fr;
    align-items: center;
    column-gap: 0.45rem;
    min-height: 28px;
  }

  .theme-row input[type="checkbox"] {
    margin: 0;
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    accent-color: var(--text-faint);
  }

  .theme-row label,
  .theme-row .theme-label {
    cursor: pointer;
    user-select: none;
    margin: 0;
    padding: 0;
    flex-grow: 1;
    font-weight: 600;
    color: var(--text-main);
  }

  .theme-row.parent-row {
    grid-template-columns: 18px 1fr;
    column-gap: 0.4rem;
  }

  .theme-row.parent-row .theme-label {
    font-weight: 700;
  }

  .icon-btn.ghost {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    padding: 0;
    cursor: pointer;
    color: var(--text-muted);
    border-radius: 0.25rem;
  }

  .icon-btn.ghost:hover {
    color: var(--text-main);
    background: rgba(255, 255, 255, 0.06);
  }

  .chevron-icon {
    font-size: 0.77em;
    transition: transform 0.2s ease;
    display: inline-block;
  }

  .custom-select-container ul {
    list-style: none;
    margin: 0.25rem 0 0.2rem 0.65rem;
    padding-left: 1.25rem;
    border-left: 2px solid var(--border-main);
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .custom-select-container ul li {
    margin: 0;
  }

  .custom-select-container ul .theme-row {
    grid-template-columns: auto 1fr;
    column-gap: 0.4rem;
  }

  .custom-select-container ul .theme-row label {
    font-weight: 600;
  }
</style>

