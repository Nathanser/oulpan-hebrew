<section class="card">
  <div class="list-header">
    <h1>Choisir mon mode de révision</h1>
  </div>

  <% const selectedModes=(params && params.modes ? (Array.isArray(params.modes) ? params.modes : [params.modes]) :
    ['flashcards']); const selectedThemes=new Set((params && params.theme_ids ? (Array.isArray(params.theme_ids) ?
    params.theme_ids : [params.theme_ids]) : []).map(v=> String(v)));
    const selectedSets = new Set((params && params.set_ids ? (Array.isArray(params.set_ids) ? params.set_ids :
    [params.set_ids]) : []).map(v => String(v)));

    let selectedRemaining = (params && typeof params.remaining !== 'undefined') ? String(params.remaining) : 'all';
    if (selectedRemaining === '10') selectedRemaining = 'all';

    const selectedRevMode = params && typeof params.rev_mode !== 'undefined' ? String(params.rev_mode) : 'order';
    const selectedPhonetic = params && typeof params.show_phonetic !== 'undefined' ? String(params.show_phonetic) : '1';
    const selectedLevel = params && params.level_id ? String(params.level_id) : '';
    %>

    <form class="form setup-grid" action="/train/session" method="post" id="setup-form"
      data-levels="<%= JSON.stringify(levels || []) %>"
      data-selected-themes="<%= JSON.stringify(Array.from(selectedThemes)) %>"
      data-selected-sets="<%= JSON.stringify(Array.from(selectedSets)) %>"
      data-selected-level="<%= JSON.stringify(selectedLevel || '') %>"
      data-selected-remaining="<%= JSON.stringify(selectedRemaining) %>">
      <% if (typeof error !=='undefined' && error) { %>
        <div class="alert alert-error">
          <%= error %>
        </div>
        <% } %>

          <div class="field-block">
            <div class="field-title">Modes de révision</div>
            <div class="mode-grid">
              <label class="check-row">
                <input type="checkbox" name="modes[]" value="flashcards" <%=selectedModes.includes('flashcards')
                  ? 'checked' : '' %>>
                <span>Flashcards classique</span>
              </label>
              <label class="check-row">
                <input type="checkbox" name="modes[]" value="flashcards_reverse"
                  <%=selectedModes.includes('flashcards_reverse') ? 'checked' : '' %>>
                <span>Flashcards reverse</span>
              </label>
              <label class="check-row">
                <input type="checkbox" name="modes[]" value="written" <%=selectedModes.includes('written') ? 'checked'
                  : '' %>>
                <span>Révision par écrit</span>
              </label>
            </div>
          </div>

          <div class="field-block">
            <div class="field-title">Thèmes et listes</div>
            <div class="theme-toggles inline">
              <label class="check-row"><input type="checkbox" id="toggle-public" <%=selectedThemes.size> 0 ? 'checked' :
                '' %>> <span>Thèmes en ligne</span></label>
              <label class="check-row"><input type="checkbox" id="toggle-lists" <%=(sets || []).some(s=>
                selectedSets.has(String(s.id))) ? 'checked' : '' %>> <span>Mes listes</span></label>
              <label class="check-row"><input type="checkbox" id="toggle-shared" <%=(sharedSets || []).some(s=>
                selectedSets.has(String(s.id))) ? 'checked' : '' %>> <span>Listes partagées</span></label>
            </div>
            <div class="theme-groups">
              <div class="theme-group" id="public-group" style="display:none;">
                <p class="muted mini" style="margin:0 0 0.2rem;">Thèmes en ligne</p>
                <% if (!themes || themes.filter(t=> !t.user_id).length === 0) { %>
                  <p class="muted mini">Aucun thème en ligne disponible.</p>
                  <% } else { %>
                    <select id="theme-select" name="theme_ids[]" multiple size="6">
                      <% themes.forEach(t=> { if (!t.user_id) { %>
                        <option value="<%= t.id %>" <%=selectedThemes.has(String(t.id)) ? 'selected' : '' %>><%= t.name
                            %>
                        </option>
                        <% } }) %>
                    </select>
                    <% } %>
              </div>
              <div class="theme-group" id="list-group" style="display:none;">
                <p class="muted mini" style="margin:0 0 0.2rem;">Mes Listes</p>
                <% if (!sets || sets.length===0) { %>
                  <p class="muted mini">Aucune liste pour le moment.</p>
                  <% } else { %>
                    <select id="list-select" name="set_ids[]" multiple size="6">
                      <% sets.forEach(s=> { %>
                        <option value="<%= s.id %>" <%=selectedSets.has(String(s.id)) ? 'selected' : '' %>><%= s.name %>
                        </option>
                        <% }) %>
                    </select>
                    <% } %>
              </div>
              <div class="theme-group" id="shared-list-group" style="display:none;">
                <p class="muted mini" style="margin:0 0 0.2rem;">Listes partagées</p>
                <% if (!sharedSets || sharedSets.length===0) { %>
                  <p class="muted mini">Aucune liste partagée.</p>
                  <% } else { %>
                    <select id="shared-list-select" name="set_ids[]" multiple size="6">
                      <% sharedSets.forEach(s=> { %>
                        <option value="<%= s.id %>" <%=selectedSets.has(String(s.id)) ? 'selected' : '' %>><%= s.name %>
                            (<%= s.owner_name %>)</option>
                        <% }) %>
                    </select>
                    <% } %>
              </div>
            </div>
          </div>

          <div class="field-block" id="level-field" style="display:none;">
            <label>Niveau
              <select name="level_id" id="level-select">
                <option value="">(Tous les niveaux)</option>
              </select>
            </label>
          </div>

          <div class="field-block">
            <div class="field-title">Nombre de mots</div>
            <div class="mode-grid">
              <label class="check-row">
                <input type="radio" name="remaining_mode" value="all" id="rm-all" <%=selectedRemaining==='all'
                  ? 'checked' : '' %>>
                <span style="white-space: nowrap;">Tout le thème/liste</span>
              </label>
              <label class="check-row">
                <input type="radio" name="remaining_mode" value="custom" id="rm-custom" <%=selectedRemaining !=='all'
                  ? 'checked' : '' %>>
                <span style="white-space: nowrap;">Nombre défini</span>
              </label>
            </div>
            <div id="slider-container" style="display:none; margin-top:0.5rem; padding-left:0.5rem;">
              <div style="display:flex; align-items:center; gap:0.75rem;">
                <input type="range" min="1" max="50"
                  value="<%= selectedRemaining !== 'all' ? selectedRemaining : '10' %>" id="remaining-slider"
                  style="flex:1; cursor:pointer;">
                <span id="slider-val" style="font-weight:700; min-width:1.5rem; text-align:right;">
                  <%= selectedRemaining !=='all' ? selectedRemaining : '10' %>
                </span>
              </div>
            </div>
            <input type="hidden" name="remaining" id="remaining-input" value="<%= selectedRemaining %>">
            <input type="hidden" name="total"
              value="<%= (params && typeof params.total !== 'undefined') ? params.total : 10 %>">
          </div>

          <details class="advanced">
            <summary style="padding-bottom: 0.3rem">Options avancees</summary>
            <div class="advanced-grid">
              <label>Mode de révision
                <select name="rev_mode">
                  <option value="order" <%=selectedRevMode==='order' ? 'selected' : '' %>>Dans l'ordre</option>
                  <option value="random" <%=selectedRevMode==='random' ? 'selected' : '' %>>Aléatoire</option>
                  <option value="favorites" <%=selectedRevMode==='favorites' ? 'selected' : '' %>>Favoris</option>
                  <option value="new" <%=selectedRevMode==='new' ? 'selected' : '' %>>Nouveaux mots</option>
                  <option value="weak" <%=selectedRevMode==='weak' ? 'selected' : '' %>>Mots faibles / Non maitrisés
                  </option>
                </select>
              </label>
              <fieldset class="check-row">
                <legend style="margin-bottom:0.35rem;">Phonétique ?</legend>
                <label class="check-row">
                  <input type="radio" name="show_phonetic" value="1" <%=selectedPhonetic !=='0' ? 'checked' : '' %>>
                  <span>Oui</span>
                </label>
                <label class="check-row">
                  <input type="radio" name="show_phonetic" value="0" <%=selectedPhonetic==='0' ? 'checked' : '' %>>
                  <span>Non</span>
                </label>
              </fieldset>
            </div>
          </details>

          <button type="submit">Démarrer</button>
    </form>
</section>

<script>
  (() => {
    const form = document.getElementById('setup-form');
    if (!form) return;

    const levelsData = JSON.parse(form.dataset.levels || '[]');
    const preselectedThemes = JSON.parse(form.dataset.selectedThemes || '[]');
    const preselectedSets = JSON.parse(form.dataset.selectedSets || '[]');
    const preselectedLevel = JSON.parse(form.dataset.selectedLevel || '""');
    const selectedRemainingValue = JSON.parse(form.dataset.selectedRemaining || '"all"');

    const levelSelect = document.getElementById('level-select');
    const levelField = document.getElementById('level-field');
    const publicGroup = document.getElementById('public-group');
    const listGroup = document.getElementById('list-group');
    const sharedListGroup = document.getElementById('shared-list-group');
    const togglePublic = document.getElementById('toggle-public');
    const toggleLists = document.getElementById('toggle-lists');
    const toggleShared = document.getElementById('toggle-shared');
    const themeSelect = document.getElementById('theme-select');
    const listSelect = document.getElementById('list-select');
    const sharedListSelect = document.getElementById('shared-list-select');
    const remainingSelect = document.querySelector('select[name="remaining"]');

    const renderLevels = () => {
      const checkedThemes = themeSelect
        ? Array.from(themeSelect.selectedOptions || []).map(o => o.value).filter(Boolean)
        : [];
      levelSelect.innerHTML = '<option value="">(Tous les niveaux)</option>';
      if (checkedThemes.length !== 1) {
        levelField.style.display = 'none';
        return;
      }
      const filtered = levelsData.filter(l => String(l.theme_id) === String(checkedThemes[0]));
      if (filtered.length === 0) {
        levelField.style.display = 'none';
        return;
      }
      filtered.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id;
        opt.textContent = l.name;
        levelSelect.appendChild(opt);
      });
      levelField.style.display = 'block';
    };

    const updateGroups = () => {
      if (publicGroup) {
        publicGroup.style.display = togglePublic && togglePublic.checked ? 'grid' : 'none';
        if (togglePublic && !togglePublic.checked) {
          if (themeSelect) themeSelect.selectedIndex = -1;
        }
      }
      if (listGroup) {
        listGroup.style.display = toggleLists && toggleLists.checked ? 'grid' : 'none';
        if (toggleLists && !toggleLists.checked) {
          if (listSelect) listSelect.selectedIndex = -1;
        }
      }
      if (sharedListGroup) {
        sharedListGroup.style.display = toggleShared && toggleShared.checked ? 'grid' : 'none';
        if (toggleShared && !toggleShared.checked) {
          if (sharedListSelect) sharedListSelect.selectedIndex = -1;
        }
      }
      renderLevels();
    };

    const updateSliderFill = () => {
      if (!slider) return;
      const min = slider.min || 1;
      const max = slider.max || 50;
      const val = slider.value;
      const percentage = ((val - min) / (max - min)) * 100;
      slider.style.setProperty('--slider-fill', `${percentage}%`);
    };

    const updateRemainingUI = () => {
      if (rmAll && rmAll.checked) {
        if (sliderContainer) sliderContainer.style.display = 'none';
        if (remainingInput) remainingInput.value = 'all';
      } else {
        if (sliderContainer) sliderContainer.style.display = 'block';
        if (remainingInput && slider) remainingInput.value = slider.value;
        updateSliderFill();
      }
    };

    if (themeSelect) themeSelect.addEventListener('change', renderLevels);
    if (listSelect) listSelect.addEventListener('change', () => { });
    if (sharedListSelect) sharedListSelect.addEventListener('change', () => { });
    if (togglePublic) togglePublic.addEventListener('change', updateGroups);
    if (toggleLists) toggleLists.addEventListener('change', updateGroups);
    if (toggleShared) toggleShared.addEventListener('change', updateGroups);
    if (themeSelect && preselectedThemes && preselectedThemes.length > 0) {
      preselectedThemes.forEach(val => {
        const opt = themeSelect.querySelector(`option[value="${val}"]`);
        if (opt) opt.selected = true;
      });
    }
    if (listSelect && preselectedSets && preselectedSets.length > 0) {
      preselectedSets.forEach(val => {
        const opt = listSelect.querySelector(`option[value="${val}"]`);
        if (opt) opt.selected = true;
      });
    }
    const rmAll = document.getElementById('rm-all');
    const rmCustom = document.getElementById('rm-custom');
    const sliderContainer = document.getElementById('slider-container');
    const slider = document.getElementById('remaining-slider');
    const sliderVal = document.getElementById('slider-val');
    const remainingInput = document.getElementById('remaining-input');

    if (rmAll) {
      rmAll.addEventListener('change', updateRemainingUI);
      rmAll.addEventListener('click', updateRemainingUI);
    }
    if (rmCustom) {
      rmCustom.addEventListener('change', updateRemainingUI);
      rmCustom.addEventListener('click', updateRemainingUI);
    }
    if (slider) {
      slider.addEventListener('input', () => {
        if (sliderVal) sliderVal.textContent = slider.value;
        if (remainingInput) remainingInput.value = slider.value;
        updateSliderFill();
      });
    }

    updateGroups(); // This calls renderLevels

    if (preselectedLevel && levelSelect) {
      levelSelect.value = preselectedLevel;
      // Ensure level field is visible if a level is selected
      if (levelSelect.value && levelField) levelField.style.display = 'block';
    }

    updateRemainingUI(); // This sets initial slider visibility and fill

    form.addEventListener('submit', () => {
      const modeInputs = Array.from(document.querySelectorAll('input[name="modes[]"]'));
      const anyChecked = modeInputs.some(i => i.checked);
      if (!anyChecked && modeInputs[0]) modeInputs[0].checked = true;
    });
  })();
</script>