<section>
  <div class="list-header">
    <div>
      <p class="eyebrow">Import / Export</p>
      <h1>
        <%= importType==='theme' ? 'Importer un thème' : 'Importer une liste' %>
      </h1>
      <p class="muted">Ajoute un thème ou une liste (JSON) ou exporte-les en ZIP.</p>
    </div>
  </div>

  <% if (importError) { %>
    <div class="alert alert-error">
      <%= importError %>
    </div>
    <% } %>
      <% if (importSuccess) { %>
        <div class="alert alert-success">
          <%= importSuccess %>
        </div>
        <% } %>

          <% if (pendingImport) { %>
            <div class="alert alert-warning">
              La Liste ou Thème existe déjà, voulez-vous ajouter ces mots à cette liste ?
              <div class="muted" style="margin-top:0.35rem;">
                <strong>
                  <%= pendingImport.name %>
                </strong> - <%= pendingImport.wordsCount %> mot<%= Number(pendingImport.wordsCount)> 1 ? 's' : '' %>
                    trouvés
              </div>
            </div>
            <div class="inline-actions" style="margin-bottom:1rem;">
              <form method="post" action="/import" class="form" style="margin-right:0.5rem;">
                <input type="hidden" name="payload" value="<%= payloadValue || '' %>" />
                <input type="hidden" name="confirm" value="append" />
                <button type="submit" class="btn">Oui</button>
              </form>
              <a class="btn ghost" href="/import">Non</a>
            </div>
            <% } %>

              <div class="card" style="margin-bottom:1rem;">
                <div class="list-header" style="margin:0 0 0.5rem;">
                  <h3 style="margin:0;">Charger un fichier JSON</h3>
                  <small class="muted">Disponible pour <%= isAdmin ? 'les thèmes admin' : 'les listes perso' %></small>
                </div>
                <form method="post" action="/import" class="form" id="import-form">
                  <label>Fichier JSON
                    <input type="file" accept=".json,application/json" id="import-file" />
                  </label>
                  <% const placeholder=importType==='theme'
                    ? '{"name":"Nouveau thème","active":1,"words":[{"hebrew":"...","french":"...","transliteration":"..."}]}'
                    : '{"name":"Nouvelle liste","words":[{"hebrew":"...","french":"...","transliteration":"..."}]}' ; %>
                    <label>Données (JSON)
                      <textarea name="payload" id="import-payload" rows="8"
                        placeholder="<%= placeholder %>"><%= payloadValue || '' %></textarea>
                    </label>
                    <button type="submit" class="btn">Importer</button>
                </form>
              </div>

              <div class="card" style="margin-bottom:1rem;">
                <div class="list-header" style="margin:0 0 0.5rem;">
                  <h3 style="margin:0;">Exporter en JSON</h3>
                  <small class="muted">
                    <%= isAdmin ? 'Thèmes admin + listes utilisateurs' : 'Mes listes personnelles' %>
                  </small>
                </div>
                <form method="post" action="/export" id="export-form">
                  <p class="muted">Choisis quoi exporter et le format.</p>
                  <label style="display:flex; align-items:center; gap:0.4rem; margin-top:0.4rem;">
                    <input type="radio" name="export_scope" value="all" checked> Tout exporter
                  </label>
                  <label style="display:flex; align-items:center; gap:0.4rem;">
                    <input type="radio" name="export_scope" value="custom"> Sélection manuelle
                  </label>
                  <% if (exportThemes && exportThemes.length && isAdmin) { %>
                    <div class="export-section" data-export-section="themes" style="display:none; margin-top:0.5rem;">
                      <p class="muted" style="margin:0 0 0.3rem;">Thèmes</p>
                      <div style="max-height:180px; overflow:auto; border:1px solid var(--border-main); padding:0.4rem; border-radius:0.5rem;">
                        <% exportThemes.forEach(t => { %>
                          <label style="display:flex; align-items:center; gap:0.35rem; margin:0.15rem 0;">
                            <input type="checkbox" name="theme_ids" value="<%= t.id %>">
                            <span><%= t.name %></span>
                          </label>
                        <% }) %>
                      </div>
                    </div>
                  <% } %>
                  <% if (exportSets && exportSets.length) { %>
                    <div class="export-section" data-export-section="sets" style="display:none; margin-top:0.6rem;">
                      <p class="muted" style="margin:0 0 0.3rem;">Listes</p>
                      <div style="max-height:180px; overflow:auto; border:1px solid var(--border-main); padding:0.4rem; border-radius:0.5rem;">
                        <% exportSets.forEach(s => { %>
                          <label style="display:flex; align-items:center; gap:0.35rem; margin:0.15rem 0;">
                            <input type="checkbox" name="set_ids" value="<%= s.id %>">
                            <span><%= s.name %><% if (s.owner_name) { %> <small class="muted">( <%= s.owner_name %> )</small><% } %></span>
                          </label>
                        <% }) %>
                      </div>
                    </div>
                  <% } %>
                  <label style="display:flex; align-items:center; gap:0.4rem; margin-top:0.6rem;">
                    <input type="checkbox" name="single_file" value="1"> Tout réunir dans un seul fichier JSON
                  </label>
                  <p class="muted" style="margin-top:0.3rem;">Sinon, export en ZIP avec un fichier par élément.</p>
                  <br>
                  <button type="submit" class="btn" style="width:100%;">Exporter</button>
                </form>
              </div>
</section>

<script>
  (() => {
    const fileInput = document.getElementById('import-file');
    const payloadArea = document.getElementById('import-payload');
    if (fileInput && payloadArea && window.FileReader) {
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = evt => {
          payloadArea.value = evt.target.result || '';
        };
        reader.readAsText(file, 'utf-8');
      });
    }

    const scopeRadios = Array.from(document.querySelectorAll('input[name="export_scope"]'));
    const sections = Array.from(document.querySelectorAll('.export-section'));
    const toggleSections = () => {
      const custom = scopeRadios.some(r => r.checked && r.value === 'custom');
      sections.forEach(sec => {
        sec.style.display = custom ? '' : 'none';
      });
    };
    scopeRadios.forEach(r => r.addEventListener('change', toggleSections));
    toggleSections();
  })();
</script>
