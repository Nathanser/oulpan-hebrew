<section class="themes-page">
  <div class="list-header">
    <h1>Thèmes</h1>
    <div class="mode-switch">
      <button type="button" class="tab-btn active" data-target="tab-actif">Actifs</button>
      <button type="button" class="tab-btn" data-target="tab-inactif">Inactifs</button>
    </div>
  </div>

  <div id="tab-actif" class="tab-panel">
    <div class="card">
      <h3 style="margin-top:0;">Thèmes actifs</h3>
      <% if (!activeThemes || activeThemes.length===0) { %>
        <p>Pas encore de thèmes publics.</p>
        <% } else { %>
          <ul class="themes-list">
            <% activeThemes.forEach(t=> { %>
              <% if (t.children && t.children.length> 0) { %>
                <!-- Parent Theme with Children -->
                <li class="theme-item has-children">
                  <div class="theme-row parent-row">
                    <div class="theme-main">
                      <button type="button" class="icon-btn ghost toggle-children-btn"
                        data-toggle-target="children-<%= t.id %>" aria-label="Voir les sous-thèmes"
                        aria-expanded="false">
                        <span class="chevron-icon">&#9654;</span>
                      </button>
                      <div class="theme-title">
                        <strong><%= t.name %></strong>
                        <span class="pill muted mini theme-pill"><%= t.children.length %> sous-thèmes</span>
                      </div>
                    </div>
                    <div class="inline-actions">
                      <!-- Parent actions if needed, maybe just visibility toggle -->
                      <button type="button" class="icon-btn ghost dots-btn" data-menu-btn aria-label="Actions">&#8942;</button>
                      <div class="card-menu" data-menu>
                        <form action="/themes/<%= t.id %>/toggle-visibility" method="post">
                          <button type="submit" class="menu-item">
                            <span>Masquer tout</span>
                            <span class="menu-icon">&#128065;</span>
                          </button>
                        </form>
                        <% if (isAdmin) { %>
                          <form action="/themes/<%= t.id %>/toggle" method="post">
                            <button type="submit" class="menu-item">
                              <span>Désactiver (admin)</span>
                              <span class="menu-icon">&#9940;</span>
                            </button>
                          </form>
                          <% } %>
                      </div>
                    </div>
                  </div>
                  <ul class="theme-children" id="children-<%= t.id %>">
                    <% t.children.forEach(child=> { %>
                      <li class="theme-row child-row">
                        <div class="theme-title">
                          <strong><%= child.name %></strong>
                          <% if (Number(child.active)===0) { %>
                            <span class="pill muted mini status-pill">Inactif (admin)</span>
                            <% } else if (Number(child.effective_active)===0) { %>
                              <span class="pill muted mini status-pill">Inactif</span>
                              <% } %>
                        </div>
                        <div class="inline-actions">
                          <a class="btn ghost" href="/themes/<%= child.id %>">Voir</a>
                          <button type="button" class="icon-btn ghost dots-btn" data-menu-btn aria-label="Actions">&#8942;</button>
                          <div class="card-menu" data-menu>
                            <% if (Number(child.active)===0) { %>
                              <% if (isAdmin) { %>
                                <form action="/themes/<%= child.id %>/toggle" method="post">
                                  <button type="submit" class="menu-item">
                                    <span>Activer (admin)</span>
                                    <span class="menu-icon">&#9940;</span>
                                  </button>
                                </form>
                                <% } else { %>
                                  <div class="menu-item muted">
                                    <span>Inactif (admin)</span>
                                  </div>
                                  <% } %>
                                    <% } else { %>
                                      <form action="/themes/<%= child.id %>/toggle-visibility" method="post">
                                        <button type="submit" class="menu-item">
                                          <span>
                                            <%= Number(child.effective_active)===0 ? 'Afficher' : 'Masquer' %>
                                          </span>
                                          <span class="menu-icon">&#128065;</span>
                                        </button>
                                      </form>
                                      <% if (isAdmin) { %>
                                        <form action="/themes/<%= child.id %>/toggle" method="post">
                                          <button type="submit" class="menu-item">
                                            <span>
                                              <%= child.active ? 'Désactiver (admin)' : 'Activer (admin)' %>
                                            </span>
                                            <span class="menu-icon">&#9940;</span>
                                          </button>
                                        </form>
                                        <% } %>
                                          <% } %>
                          </div>
                        </div>
                      </li>
                      <% }) %>
                  </ul>
                </li>
                <% } else { %>
                  <!-- Standard Theme -->
                  <li class="theme-item">
                    <div class="theme-row leaf-row">
                      <div class="theme-title">
                        <strong><%= t.name %></strong>
                      </div>
                      <div class="inline-actions">
                        <a class="btn ghost" href="/themes/<%= t.id %>">Voir</a>
                        <button type="button" class="icon-btn ghost dots-btn" data-menu-btn aria-label="Actions">&#8942;</button>
                        <div class="card-menu" data-menu>
                          <form action="/themes/<%= t.id %>/toggle-visibility" method="post">
                            <button type="submit" class="menu-item">
                              <span>Masquer</span>
                              <span class="menu-icon">&#128065;</span>
                            </button>
                          </form>
                          <% if (isAdmin) { %>
                            <form action="/themes/<%= t.id %>/toggle" method="post">
                              <button type="submit" class="menu-item">
                                <span>Désactiver (admin)</span>
                                <span class="menu-icon">&#9940;</span>
                              </button>
                            </form>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  </li>
                  <% } %>
                    <% }) %>
          </ul>
          <% } %>
    </div>
  </div>

  <div id="tab-inactif" class="tab-panel" style="display:none;">
    <div class="card">
      <h3 style="margin-top:0;">Thèmes inactifs</h3>
      <% const hasInactive=(inactivePersonal && inactivePersonal.length> 0) || (inactiveProposed &&
        inactiveProposed.length > 0); %>
        <% if (!hasInactive) { %>
          <p>Aucun thème inactif.</p>
          <% } %>

            <% if (inactivePersonal && inactivePersonal.length> 0) { %>
              <p class="eyebrow">Inactifs pour moi</p>
              <ul class="themes-list">
                <% inactivePersonal.forEach(t=> { %>
                  <li class="theme-item">
                    <div class="theme-row leaf-row">
                      <div class="theme-title">
                        <strong><%= t.name %></strong>
                        <span class="pill muted mini status-pill">Inactif pour moi</span>
                      </div>
                      <div class="inline-actions">
                        <a class="btn ghost" href="/themes/<%= t.id %>">Voir</a>
                        <button type="button" class="icon-btn ghost dots-btn" data-menu-btn aria-label="Actions">&#8942;</button>
                        <div class="card-menu" data-menu>
                          <form action="/themes/<%= t.id %>/toggle-visibility" method="post">
                            <button type="submit" class="menu-item">
                              <span>Afficher</span>
                              <span class="menu-icon">&#128065;</span>
                            </button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </li>
                  <% }) %>
              </ul>
              <br>
              <% } %>

                <% if (inactiveProposed && inactiveProposed.length> 0) { %>
                  <p class="eyebrow">Inactifs (admin)</p>
                  <ul class="themes-list">
                    <% inactiveProposed.forEach(t=> { %>
                      <li class="theme-item">
                        <div class="theme-row leaf-row">
                          <div class="theme-title">
                            <strong><%= t.name %></strong>
                            <% if (!isAdmin) { %>
                              <span class="pill muted mini status-pill">Inactif</span>
                            <% } %>
                          </div>
                          <div class="inline-actions">
                            <% if (isAdmin) { %>
                              <form action="/themes/<%= t.id %>/toggle" method="post" style="margin:0;">
                                <button class="btn ghost" type="submit" title="Activer">Activer</button>
                              </form>
                              <% } else { %>
                                <span class="pill muted mini status-pill">Inactif</span>
                                <% } %>
                          </div>
                        </div>
                      </li>
                      <% }) %>
                  </ul>
                  <% } %>
    </div>
  </div>
</section>

<script>
  (() => {
    const tabs = document.querySelectorAll('.tab-btn');
    const panels = document.querySelectorAll('.tab-panel');
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.dataset.target;
        panels.forEach(p => {
          p.style.display = p.id === target ? 'block' : 'none';
        });
      });
    });

    const closeMenus = () => {
      document.querySelectorAll('.card-menu.open').forEach(m => m.classList.remove('open'));
    };
    document.querySelectorAll('[data-menu-btn]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const menu = btn.parentElement.querySelector('[data-menu]');
        if (!menu) return;
        const isOpen = menu.classList.contains('open');
        closeMenus();
        if (!isOpen) menu.classList.add('open');
      });
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.inline-actions')) closeMenus();
    });
    const toggleChildren = (btn, forceOpen = null) => {
      const targetId = btn.dataset.toggleTarget;
      const target = document.getElementById(targetId);
      const icon = btn.querySelector('.chevron-icon');
      const parentItem = btn.closest('.theme-item');
      if (!target || !parentItem) return;
      const isOpen = parentItem.classList.contains('is-open');
      const shouldOpen = forceOpen !== null ? forceOpen : !isOpen;
      parentItem.classList.toggle('is-open', shouldOpen);
      btn.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
      if (icon) icon.innerHTML = shouldOpen ? '&#9660;' : '&#9654;';
    };
    document.querySelectorAll('.toggle-children-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleChildren(btn);
      });
    });
    document.querySelectorAll('.theme-row.parent-row .theme-title').forEach(title => {
      const btn = title.closest('.parent-row')?.querySelector('.toggle-children-btn');
      if (!btn) return;
      title.addEventListener('click', () => toggleChildren(btn));
    });
  })();
</script>
