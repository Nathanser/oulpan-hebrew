<section class="card set-builder">
  <div class="builder-header">
    <div>
      <p class="eyebrow">Partager ma liste</p>
      <h1>
        <%= set.name %>
      </h1>
    </div>
    <div class="builder-actions">
      <a class="link back-link" href="/my/lists">&#8592; Retour</a>
    </div>
  </div>

  <form method="post" action="/my/lists/<%= set.id %>/share" class="form">
    <% if (!users || users.length===0) { %>
      <p class="muted">Aucun utilisateur à partager.</p>
      <% } else { %>
        <div class="grid two-cols" style="gap:1rem;">
          <div>
            <p class="eyebrow">Lecture seule</p>
            <div class="options-list">
              <% users.forEach(u=> { %>
                <label class="check-row">
                  <input type="checkbox" name="user_ids" data-user="<%= u.id %>" value="<%= u.id %>" <%=currentShared &&
                    currentShared.includes(Number(u.id)) ? 'checked' : '' %> />
                  <span>
                    <%= u.display_name %> (<%= u.email %>)
                  </span>
                </label>
                <% }) %>
            </div>
          </div>
          <div>
            <p class="eyebrow">Collaborateurs (peuvent modifier)</p>
            <p class="muted mini">Ils peuvent ajouter/éditer les cartes mais pas supprimer la liste.</p>
            <div class="options-list">
              <% users.forEach(u=> { %>
                <label class="check-row">
                  <input type="checkbox" name="collaborator_ids" data-user="<%= u.id %>" value="<%= u.id %>"
                    <%=currentCollaborators && currentCollaborators.includes(Number(u.id)) ? 'checked' : '' %> />
                  <span>
                    <%= u.display_name %> (<%= u.email %>)
                  </span>
                </label>
                <% }) %>
            </div>
          </div>
        </div>
        <button type="submit" class="cta">Enregistrer le partage</button>
        <% } %>
  </form>
</section>

<script>
  (() => {
    const readBoxes = Array.from(document.querySelectorAll('input[name="user_ids"]'));
    const collabBoxes = Array.from(document.querySelectorAll('input[name="collaborator_ids"]'));
    const byUser = {};
    const register = (list, kind) => {
      list.forEach(box => {
        const id = box.dataset.user;
        if (!byUser[id]) byUser[id] = { read: null, collab: null };
        byUser[id][kind] = box;
      });
    };
    register(readBoxes, 'read');
    register(collabBoxes, 'collab');

    Object.values(byUser).forEach(entry => {
      const toggle = (sourceKey, otherKey) => {
        const source = entry[sourceKey];
        const other = entry[otherKey];
        if (!source) return;
        source.addEventListener('change', () => {
          if (source.checked && other) other.checked = false;
        });
        source.addEventListener('click', () => {
          if (source.checked === true && source.dataset.justToggled === '1') {
            source.checked = false;
          }
          source.dataset.justToggled = source.checked ? '1' : '0';
        });
      };
      toggle('read', 'collab');
      toggle('collab', 'read');
    });
  })();
</script>